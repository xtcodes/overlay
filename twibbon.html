<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Twibbon Generator</title>
  <style>
    body {
      font-family: sans-serif;
      text-align: center;
      margin: 0;
      padding: 20px;
    }

    canvas {
      max-width: 100%;
      touch-action: none;
      background-color: #f0f0f0;
    }

    .btn {
      padding: 10px 20px;
      margin: 10px 5px;
      font-size: 16px;
      cursor: pointer;
      border-radius: 6px;
      border: none;
      background-color: #007bff;
      color: white;
    }

    #uploadTwibbonBtn {
      position: absolute;
      top: 20px;
      left: 20px;
      z-index: 10;
    }

    #canvasWrapper {
      position: relative;
      display: inline-block;
    }

    #uploadInput, #twibbonInput {
      display: none;
    }
  </style>
</head>
<body>
  <h2>Twibbon Generator</h2>

  <!-- Tombol Unggah Gambar -->
  <button id="uploadBtn" class="btn">Unggah Gambar</button>
  <input type="file" id="uploadInput" accept="image/*" />

  <!-- Tombol Unggah Twibbon -->
  <button id="uploadTwibbonBtn" class="btn" style="display:none;">Ubah Twibbon</button>
  <input type="file" id="twibbonInput" accept="image/png" />

  <!-- Canvas -->
  <div id="canvasWrapper">
    <canvas id="canvas" width="500" height="500"></canvas>
  </div>

  <!-- Tombol Unduh dan Bagikan -->
  <br/>
  <button id="unduhBtn" class="btn" style="display:none;">Unduh Hasil Twibbon</button>
  <button id="bagikanBtn" class="btn" style="display:none;">Bagikan</button>

  <script>
    const canvas = document.getElementById("canvas");
    const ctx = canvas.getContext("2d");
    const uploadInput = document.getElementById("uploadInput");
    const uploadBtn = document.getElementById("uploadBtn");
    const unduhBtn = document.getElementById("unduhBtn");
    const bagikanBtn = document.getElementById("bagikanBtn");
    const uploadTwibbonBtn = document.getElementById("uploadTwibbonBtn");
    const twibbonInput = document.getElementById("twibbonInput");

    let userImage = null;
    let twibbonImage = new Image();
    let placeholderImage = new Image();
    let scale = 1;
    let posX = 0, posY = 0;
    let lastTouchDistance = null;
    let lastTouchPos = null;
    let dragging = false;

    placeholderImage.src = "placeholder.png"; // Ganti dengan file placeholder milikmu

    // Render awal (placeholder)
    placeholderImage.onload = () => drawCanvas();

    function drawCanvas() {
      ctx.clearRect(0, 0, canvas.width, canvas.height);

      if (userImage) {
        ctx.save();
        ctx.translate(posX, posY);
        ctx.scale(scale, scale);
        ctx.drawImage(userImage, 0, 0);
        ctx.restore();

        // Twibbon transparan saat digeser/zoom
        ctx.globalAlpha = dragging ? 0.5 : 1.0;
        if (twibbonImage.complete && twibbonImage.naturalWidth > 0) {
          ctx.drawImage(twibbonImage, 0, 0, canvas.width, canvas.height);
        }
        ctx.globalAlpha = 1;
      } else {
        ctx.drawImage(placeholderImage, 0, 0, canvas.width, canvas.height);
      }
    }

    // Tombol unggah gambar
    uploadBtn.addEventListener("click", () => {
      uploadInput.click();
    });

    uploadInput.addEventListener("change", (e) => {
      const file = e.target.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = function (event) {
        userImage = new Image();
        userImage.onload = function () {
          // Set ukuran canvas sesuai gambar asli
          canvas.width = userImage.naturalWidth;
          canvas.height = userImage.naturalHeight;
          scale = 1;
          posX = 0;
          posY = 0;
          drawCanvas();
          uploadBtn.style.display = "none";
          unduhBtn.style.display = "inline-block";
          uploadTwibbonBtn.style.display = "inline-block";
        };
        userImage.src = event.target.result;
      };
      reader.readAsDataURL(file);
    });

    // Unggah twibbon
    uploadTwibbonBtn.addEventListener("click", () => {
      twibbonInput.click();
    });

    twibbonInput.addEventListener("change", (e) => {
      const file = e.target.files[0];
      if (!file || !file.type.includes("png")) {
        alert("Twibbon harus berformat PNG dengan bagian transparan.");
        return;
      }

      const reader = new FileReader();
      reader.onload = function (event) {
        const tempImage = new Image();
        tempImage.onload = () => {
          // Validasi transparansi
          const tempCanvas = document.createElement("canvas");
          tempCanvas.width = tempImage.width;
          tempCanvas.height = tempImage.height;
          const tempCtx = tempCanvas.getContext("2d");
          tempCtx.drawImage(tempImage, 0, 0);
          const data = tempCtx.getImageData(0, 0, tempCanvas.width, tempCanvas.height).data;
          let hasTransparent = false;
          for (let i = 3; i < data.length; i += 4) {
            if (data[i] < 255) {
              hasTransparent = true;
              break;
            }
          }

          if (!hasTransparent) {
            alert("Twibbon tidak memiliki bagian transparan!");
            return;
          }

          twibbonImage = tempImage;
          drawCanvas();
        };
        tempImage.src = event.target.result;
      };
      reader.readAsDataURL(file);
    });

    // Unduh hasil
    unduhBtn.addEventListener("click", () => {
      const link = document.createElement("a");
      link.download = "twibbon.png";
      link.href = canvas.toDataURL("image/png");
      link.click();
      unduhBtn.style.display = "none";
      bagikanBtn.style.display = "inline-block";
    });

    // Web Share API
    bagikanBtn.addEventListener("click", async () => {
      canvas.toBlob(async (blob) => {
        const file = new File([blob], "twibbon.png", { type: "image/png" });
        if (navigator.canShare && navigator.canShare({ files: [file] })) {
          try {
            await navigator.share({
              title: "Twibbon Saya",
              text: "Lihat hasil twibbon ku!",
              files: [file],
            });
          } catch (err) {
            alert("Gagal membagikan.");
          }
        } else {
          alert("Web Share API tidak didukung di perangkat ini.");
        }
      });
    });

    // Drag & Zoom gesture
    canvas.addEventListener("touchstart", (e) => {
      if (e.touches.length === 1) {
        dragging = true;
        lastTouchPos = [e.touches[0].clientX, e.touches[0].clientY];
      } else if (e.touches.length === 2) {
        lastTouchDistance = getDistance(e.touches[0], e.touches[1]);
      }
    });

    canvas.addEventListener("touchmove", (e) => {
      e.preventDefault();
      if (e.touches.length === 1 && dragging) {
        const dx = e.touches[0].clientX - lastTouchPos[0];
        const dy = e.touches[0].clientY - lastTouchPos[1];
        posX += dx;
        posY += dy;
        lastTouchPos = [e.touches[0].clientX, e.touches[0].clientY];
        drawCanvas();
      } else if (e.touches.length === 2) {
        const newDistance = getDistance(e.touches[0], e.touches[1]);
        const delta = newDistance - lastTouchDistance;
        scale += delta * 0.005;
        scale = Math.max(0.5, Math.min(scale, 3));
        lastTouchDistance = newDistance;
        drawCanvas();
      }
    }, { passive: false });

    canvas.addEventListener("touchend", () => {
      dragging = false;
      drawCanvas();
    });

    function getDistance(touch1, touch2) {
      const dx = touch1.clientX - touch2.clientX;
      const dy = touch1.clientY - touch2.clientY;
      return Math.sqrt(dx * dx + dy * dy);
    }
  </script>
</body>
</html>

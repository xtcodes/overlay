<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Twibbon PFP</title>
<style>
    body {
        font-family: sans-serif;
        margin: 0;
        background: #f5f5f5;
        display: flex;
        flex-direction: column;
        align-items: center;
        padding: 10px;
    }
    .drop-area {
        position: relative;
        width: 100%;
        max-width: 400px;
        aspect-ratio: 1 / 1;
        border: 2px dashed #aaa;
        border-radius: 10px;
        display: flex;
        align-items: center;
        justify-content: center;
        overflow: hidden;
        background: white;
    }
    .drop-area.hover {
        border-color: #333;
    }
    #twibbonCanvas {
        position: absolute;
        width: 100%;
        height: 100%;
        touch-action: none;
    }
    .placeholder {
        color: #aaa;
        font-size: 16px;
        text-align: center;
        padding: 10px;
        pointer-events: none;
    }
    .controls {
        width: 100%;
        max-width: 400px;
        margin-top: 10px;
        display: flex;
        gap: 5px;
    }
    .controls button {
        flex: 1;
        padding: 10px;
        font-size: 16px;
        border: none;
        border-radius: 5px;
        cursor: pointer;
    }
    #downloadBtn:disabled {
        background-color: rgba(0,0,0,0.2);
        color: rgba(255,255,255,0.6);
        cursor: not-allowed;
    }
    #downloadBtn {
        background-color: #4CAF50;
        color: white;
    }
    #shareBtn {
        background-color: #2196F3;
        color: white;
    }
    #resetBtn {
        background-color: #f44336;
        color: white;
    }
    /* Animasi dot pulse */
    .dot-pulse {
        position: absolute;
        top: 8px;
        left: 8px;
        width: 10px;
        height: 10px;
        background-color: black;
        border-radius: 50%;
        animation: pulse 1s infinite;
    }
    @keyframes pulse {
        0%, 100% { transform: scale(1); opacity: 1; }
        50% { transform: scale(1.5); opacity: 0.5; }
    }
    /* Animasi teks loading */
    .loading-text {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        color: black;
        font-size: 18px;
        font-weight: bold;
        white-space: nowrap;
    }
    .loading-text::after {
        content: '';
        animation: dots 1.5s infinite;
    }
    @keyframes dots {
        0% { content: ''; }
        33% { content: '.'; }
        66% { content: '..'; }
        100% { content: '...'; }
    }
</style>
</head>
<body>

<div class="drop-area" id="dropArea">
    <canvas id="twibbonCanvas"></canvas>
    <div class="placeholder" id="placeholder">Tarik & letakkan gambar di sini<br>atau klik untuk unggah</div>
</div>

<div class="controls">
    <button id="downloadBtn" disabled>Unduh</button>
    <button id="shareBtn" style="display:none;">Bagikan</button>
    <button id="resetBtn" style="display:none;">Reset</button>
</div>

<input type="file" id="fileInput" accept="image/*" style="display:none;">

<script>
const dropArea = document.getElementById('dropArea');
const fileInput = document.getElementById('fileInput');
const canvas = document.getElementById('twibbonCanvas');
const ctx = canvas.getContext('2d');
const placeholder = document.getElementById('placeholder');
const downloadBtn = document.getElementById('downloadBtn');
const shareBtn = document.getElementById('shareBtn');
const resetBtn = document.getElementById('resetBtn');

let userImg = null;
let twibbonImg = new Image();
twibbonImg.src = 'twibbon.png'; // ganti dengan twibbon asli
let scale = 1, posX = 0, posY = 0, dragging = false;
let lastX, lastY, pinchDist = 0;

// Set ukuran canvas
function resizeCanvas() {
    canvas.width = dropArea.clientWidth;
    canvas.height = dropArea.clientHeight;
    drawCanvas();
}
window.addEventListener('resize', resizeCanvas);
resizeCanvas();

function drawCanvas(twibbonAlpha = 1) {
    ctx.clearRect(0, 0, canvas.width, canvas.height);
    if (!userImg) {
        placeholder.style.display = 'block';
        return;
    }
    placeholder.style.display = 'none';
    ctx.drawImage(userImg, posX, posY, userImg.width * scale, userImg.height * scale);
    ctx.globalAlpha = twibbonAlpha;
    ctx.drawImage(twibbonImg, 0, 0, canvas.width, canvas.height);
    ctx.globalAlpha = 1;
}

// Drag & drop upload
dropArea.addEventListener('click', () => fileInput.click());
dropArea.addEventListener('dragover', e => { e.preventDefault(); dropArea.classList.add('hover'); });
dropArea.addEventListener('dragleave', () => dropArea.classList.remove('hover'));
dropArea.addEventListener('drop', e => {
    e.preventDefault();
    dropArea.classList.remove('hover');
    handleFile(e.dataTransfer.files[0]);
});
fileInput.addEventListener('change', e => handleFile(e.target.files[0]));

function handleFile(file) {
    if (!file) return;
    const reader = new FileReader();
    reader.onload = e => {
        const img = new Image();
        img.onload = () => {
            userImg = img;
            scale = Math.min(canvas.width / img.width, canvas.height / img.height);
            posX = (canvas.width - img.width * scale) / 2;
            posY = (canvas.height - img.height * scale) / 2;
            drawCanvas();
            downloadBtn.disabled = false;
        };
        img.src = e.target.result;
    };
    reader.readAsDataURL(file);
}

// Gesture
canvas.addEventListener('touchstart', e => {
    if (e.touches.length === 1) {
        dragging = true;
        lastX = e.touches[0].clientX;
        lastY = e.touches[0].clientY;
    } else if (e.touches.length === 2) {
        pinchDist = getPinchDist(e);
    }
});
canvas.addEventListener('touchmove', e => {
    e.preventDefault();
    if (e.touches.length === 1 && dragging) {
        const dx = e.touches[0].clientX - lastX;
        const dy = e.touches[0].clientY - lastY;
        lastX = e.touches[0].clientX;
        lastY = e.touches[0].clientY;
        posX += dx;
        posY += dy;
        drawCanvas(0.5);
    } else if (e.touches.length === 2) {
        const newDist = getPinchDist(e);
        scale *= newDist / pinchDist;
        pinchDist = newDist;
        drawCanvas(0.5);
    }
});
canvas.addEventListener('touchend', () => { dragging = false; drawCanvas(); });

function getPinchDist(e) {
    const dx = e.touches[0].clientX - e.touches[1].clientX;
    const dy = e.touches[0].clientY - e.touches[1].clientY;
    return Math.sqrt(dx * dx + dy * dy);
}

// Download logic dengan efek abu-abu + dot pulse + teks
downloadBtn.addEventListener('click', () => {
    if (!userImg) return;

    downloadBtn.disabled = true;

    // Overlay efek
    ctx.fillStyle = 'rgba(128,128,128,0.5)';
    ctx.fillRect(0, 0, canvas.width, canvas.height);

    const dot = document.createElement('div');
    dot.className = 'dot-pulse';
    dropArea.appendChild(dot);

    const text = document.createElement('div');
    text.className = 'loading-text';
    text.textContent = 'Sedang proses';
    dropArea.appendChild(text);

    setTimeout(() => {
        // Render HD
        const offCanvas = document.createElement('canvas');
        offCanvas.width = 3000;
        offCanvas.height = 3000;
        const offCtx = offCanvas.getContext('2d');
        offCtx.drawImage(userImg, posX * (3000 / canvas.width), posY * (3000 / canvas.height), userImg.width * scale * (3000 / canvas.width), userImg.height * scale * (3000 / canvas.height));
        offCtx.drawImage(twibbonImg, 0, 0, 3000, 3000);
        const link = document.createElement('a');
        link.download = 'twibbon.png';
        link.href = offCanvas.toDataURL('image/png');
        link.click();

        // Bersihkan efek
        dot.remove();
        text.remove();
        drawCanvas();

        // Tampilkan tombol share & reset
        downloadBtn.style.display = 'none';
        shareBtn.style.display = 'block';
        resetBtn.style.display = 'block';
    }, 15000);
});

resetBtn.addEventListener('click', () => {
    userImg = null;
    scale = 1;
    posX = 0;
    posY = 0;
    drawCanvas();
    downloadBtn.disabled = true;
    downloadBtn.style.display = 'block';
    shareBtn.style.display = 'none';
    resetBtn.style.display = 'none';
});
</script>
</body>
</html>

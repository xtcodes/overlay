<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Twibbon PFP</title>
<style>
  body { font-family: sans-serif; margin: 0; padding: 0; background: #f0f0f0; }
  .container { max-width: 400px; margin: auto; padding: 10px; }
  .drop-area {
    border: 2px dashed #ccc;
    border-radius: 10px;
    padding: 10px;
    text-align: center;
    background: white;
    position: relative;
  }
  canvas { width: 100%; background: #fff; display: block; }
  #hint { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
          color: #aaa; font-size: 14px; text-align: center; }
  button { padding: 10px; margin-top: 10px; font-size: 16px; border: none; border-radius: 5px; }
  #btnDownload { width: 100%; background: #4CAF50; color: white; }
  .row { display: flex; gap: 5px; }
  .row button { flex: 1; }
  #btnShare { background: #2196F3; color: white; }
  #btnReset { background: #f44336; color: white; }
</style>
</head>
<body>

<div class="container">
  <div class="drop-area" id="dropArea">
    <input type="file" id="fileInput" accept="image/*" style="display:none;">
    <canvas id="canvas" width="800" height="800"></canvas>
    <div id="hint">Tarik & Lepas gambar<br>atau ketuk untuk pilih</div>
  </div>

  <button id="btnDownload" disabled>Unduh</button>
  <div class="row" style="display:none;">
    <button id="btnShare">Bagikan</button>
    <button id="btnReset">Reset</button>
  </div>
</div>

<script>
const dropArea = document.getElementById('dropArea');
const fileInput = document.getElementById('fileInput');
const canvas = document.getElementById('canvas');
const ctx = canvas.getContext('2d');
const hint = document.getElementById('hint');
const btnDownload = document.getElementById('btnDownload');
const btnShare = document.getElementById('btnShare');
const btnReset = document.getElementById('btnReset');
const rowBtns = document.querySelector('.row');

let userImage = null;
let twibbonImage = new Image();
twibbonImage.src = 'twibbon.png'; // ganti path twibbon default
let scale = 1, originX = 0, originY = 0;
let lastTouchDist = null, lastX = 0, lastY = 0, isDragging = false;

function drawPlaceholder() {
  ctx.fillStyle = "#fff";
  ctx.fillRect(0, 0, canvas.width, canvas.height);
  ctx.fillStyle = "#aaa";
  ctx.font = "24px sans-serif";
  ctx.textAlign = "center";
  ctx.fillText("Belum ada gambar", canvas.width/2, canvas.height/2);
}

function drawCanvas() {
  ctx.clearRect(0, 0, canvas.width, canvas.height);
  if (userImage) {
    ctx.save();
    ctx.translate(canvas.width/2 + originX, canvas.height/2 + originY);
    ctx.scale(scale, scale);
    ctx.drawImage(userImage, -userImage.width/2, -userImage.height/2);
    ctx.restore();
  }
  if (twibbonImage.complete) ctx.drawImage(twibbonImage, 0, 0, canvas.width, canvas.height);
}

dropArea.addEventListener('click', () => fileInput.click());

fileInput.addEventListener('change', e => {
  if (e.target.files.length) handleFile(e.target.files[0]);
});

dropArea.addEventListener('dragover', e => {
  e.preventDefault(); dropArea.style.borderColor = "#4CAF50";
});
dropArea.addEventListener('dragleave', () => dropArea.style.borderColor = "#ccc");
dropArea.addEventListener('drop', e => {
  e.preventDefault(); dropArea.style.borderColor = "#ccc";
  if (e.dataTransfer.files.length) handleFile(e.dataTransfer.files[0]);
});

function handleFile(file) {
  const reader = new FileReader();
  reader.onload = e => {
    const img = new Image();
    img.onload = () => {
      userImage = img;
      fileInput.disabled = true;
      btnDownload.disabled = false;
      hint.style.display = 'none'; // sembunyikan hint
      drawCanvas();
    };
    img.src = e.target.result;
  };
  reader.readAsDataURL(file);
}

// Gesture
canvas.addEventListener('touchstart', e => {
  if (e.touches.length === 1) {
    isDragging = true;
    lastX = e.touches[0].clientX;
    lastY = e.touches[0].clientY;
    twibbonImage.styleOpacity = 0.5;
  } else if (e.touches.length === 2) {
    lastTouchDist = getTouchDist(e.touches);
    twibbonImage.styleOpacity = 0.5;
  }
});
canvas.addEventListener('touchmove', e => {
  e.preventDefault();
  if (e.touches.length === 1 && isDragging) {
    originX += e.touches[0].clientX - lastX;
    originY += e.touches[0].clientY - lastY;
    lastX = e.touches[0].clientX;
    lastY = e.touches[0].clientY;
    drawCanvas();
  } else if (e.touches.length === 2) {
    const dist = getTouchDist(e.touches);
    if (lastTouchDist) scale *= dist / lastTouchDist;
    lastTouchDist = dist;
    drawCanvas();
  }
});
canvas.addEventListener('touchend', e => {
  if (e.touches.length === 0) {
    isDragging = false;
    lastTouchDist = null;
    drawCanvas(); // twibbon kembali normal
  }
});
function getTouchDist(touches) {
  const dx = touches[0].clientX - touches[1].clientX;
  const dy = touches[0].clientY - touches[1].clientY;
  return Math.sqrt(dx*dx + dy*dy);
}

// Download
btnDownload.addEventListener('click', () => {
  const link = document.createElement('a');
  link.download = 'twibbon.png';
  link.href = canvas.toDataURL('image/png', 1.0);
  link.click();
  btnDownload.style.display = 'none';
  rowBtns.style.display = 'flex';
});

// Share
btnShare.addEventListener('click', async () => {
  const blob = await (await fetch(canvas.toDataURL('image/png'))).blob();
  const file = new File([blob], 'twibbon.png', { type: 'image/png' });
  if (navigator.share) {
    navigator.share({ files: [file] });
  } else {
    alert('Fitur berbagi tidak didukung di browser ini.');
  }
});

// Reset
btnReset.addEventListener('click', () => {
  userImage = null;
  originX = originY = 0; scale = 1;
  fileInput.disabled = false;
  btnDownload.disabled = true;
  btnDownload.style.display = 'block';
  rowBtns.style.display = 'none';
  hint.style.display = 'block'; // tampilkan kembali hint
  drawPlaceholder();
});

drawPlaceholder();
</script>
</body>
</html>

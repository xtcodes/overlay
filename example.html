<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Twibbon PFP</title>
<style>
    body {
        font-family: sans-serif;
        background: #f0f0f0;
        margin: 0;
        padding: 10px;
        text-align: center;
    }
    #drop-area {
        border: 2px dashed #ccc;
        padding: 10px;
        position: relative;
        background: white;
        max-width: 400px;
        margin: auto;
    }
    canvas {
        width: 100%;
        height: auto;
        display: block;
        background: #ddd;
    }
    #buttons {
        margin-top: 10px;
        display: flex;
        flex-wrap: wrap;
        gap: 10px;
        justify-content: center;
    }
    button {
        flex: 1;
        padding: 10px;
        font-size: 16px;
        border: none;
        border-radius: 6px;
        cursor: pointer;
    }
    #downloadBtn:disabled {
        background: rgba(0,0,0,0.2);
        cursor: not-allowed;
    }
    #downloadBtn { background: #28a745; color: white; }
    #shareBtn { background: #007bff; color: white; display: none; }
    #resetBtn { background: #dc3545; color: white; display: none; }
</style>
</head>
<body>

<h2>Twibbon PFP</h2>

<div id="drop-area">
    <input type="file" id="fileElem" accept="image/*" style="display:none">
    <p id="placeholder-text">Tarik & Lepas Gambar di sini atau Klik</p>
    <canvas id="canvas" width="1024" height="1024"></canvas>
</div>

<div id="buttons">
    <button id="downloadBtn" disabled>Unduh</button>
    <button id="shareBtn">Bagikan</button>
    <button id="resetBtn">Reset</button>
</div>

<script>
const dropArea = document.getElementById('drop-area');
const fileElem = document.getElementById('fileElem');
const placeholderText = document.getElementById('placeholder-text');
const canvas = document.getElementById('canvas');
const ctx = canvas.getContext('2d');

const downloadBtn = document.getElementById('downloadBtn');
const shareBtn = document.getElementById('shareBtn');
const resetBtn = document.getElementById('resetBtn');

let img = null;
let twibbon = new Image();
twibbon.src = 'twibbon.png'; // ganti path twibbon
let scale = 1, originX = 0, originY = 0, lastX, lastY, dragging = false;
let fingers = 0, lastDist = 0;
let twibbonAlpha = 1;

function drawPlaceholder() {
    ctx.fillStyle = "#ddd";
    ctx.fillRect(0,0,canvas.width,canvas.height);
    ctx.fillStyle = "#666";
    ctx.font = "30px sans-serif";
    ctx.textAlign = "center";
    ctx.fillText("Upload gambar Anda", canvas.width/2, canvas.height/2);
}
drawPlaceholder();

dropArea.addEventListener('click', () => fileElem.click());

fileElem.addEventListener('change', e => {
    if (e.target.files.length) {
        loadImage(e.target.files[0]);
    }
});

dropArea.addEventListener('dragover', e => {
    e.preventDefault();
    dropArea.style.borderColor = '#000';
});
dropArea.addEventListener('dragleave', e => {
    dropArea.style.borderColor = '#ccc';
});
dropArea.addEventListener('drop', e => {
    e.preventDefault();
    dropArea.style.borderColor = '#ccc';
    if (e.dataTransfer.files.length) {
        loadImage(e.dataTransfer.files[0]);
    }
});

function loadImage(file) {
    const reader = new FileReader();
    reader.onload = function(evt) {
        img = new Image();
        img.onload = () => {
            placeholderText.style.display = 'none';
            originX = (canvas.width - img.width)/2;
            originY = (canvas.height - img.height)/2;
            scale = 1;
            draw();
            downloadBtn.disabled = false;
        };
        img.src = evt.target.result;
    };
    reader.readAsDataURL(file);
}

function draw() {
    ctx.clearRect(0,0,canvas.width,canvas.height);
    if (img) {
        ctx.drawImage(img, originX, originY, img.width*scale, img.height*scale);
        ctx.globalAlpha = twibbonAlpha;
        ctx.drawImage(twibbon, 0, 0, canvas.width, canvas.height);
        ctx.globalAlpha = 1;
    } else {
        drawPlaceholder();
    }
}

// Gesture
canvas.addEventListener('touchstart', e => {
    if (!img) return;
    fingers = e.touches.length;
    if (fingers === 1) {
        dragging = true;
        lastX = e.touches[0].clientX;
        lastY = e.touches[0].clientY;
    } else if (fingers === 2) {
        lastDist = Math.hypot(
            e.touches[0].clientX - e.touches[1].clientX,
            e.touches[0].clientY - e.touches[1].clientY
        );
    }
    twibbonAlpha = 0.5;
    draw();
});
canvas.addEventListener('touchmove', e => {
    if (!img) return;
    if (fingers === 1 && dragging) {
        originX += e.touches[0].clientX - lastX;
        originY += e.touches[0].clientY - lastY;
        lastX = e.touches[0].clientX;
        lastY = e.touches[0].clientY;
    } else if (fingers === 2) {
        const dist = Math.hypot(
            e.touches[0].clientX - e.touches[1].clientX,
            e.touches[0].clientY - e.touches[1].clientY
        );
        scale *= dist / lastDist;
        lastDist = dist;
    }
    draw();
});
canvas.addEventListener('touchend', e => {
    fingers = e.touches.length;
    if (fingers === 0) {
        dragging = false;
        twibbonAlpha = 1;
        draw();
    }
});

// Mouse drag
canvas.addEventListener('mousedown', e => {
    if (!img) return;
    dragging = true;
    lastX = e.clientX;
    lastY = e.clientY;
    twibbonAlpha = 0.5;
    draw();
});
canvas.addEventListener('mousemove', e => {
    if (!img || !dragging) return;
    originX += e.clientX - lastX;
    originY += e.clientY - lastY;
    lastX = e.clientX;
    lastY = e.clientY;
    draw();
});
canvas.addEventListener('mouseup', () => {
    dragging = false;
    twibbonAlpha = 1;
    draw();
});

// Unduh HD + efek abu-abu + countdown
downloadBtn.addEventListener('click', () => {
    if (!img) return;
    downloadBtn.disabled = true;

    let countdown = 15;
    const overlay = document.createElement('canvas');
    overlay.width = canvas.width;
    overlay.height = canvas.height;
    const octx = overlay.getContext('2d');

    const interval = setInterval(() => {
        octx.fillStyle = 'rgba(128,128,128,0.8)';
        octx.fillRect(0,0,overlay.width,overlay.height);

        // Dot pulse kiri atas
        octx.beginPath();
        octx.arc(20, 20, 8 + Math.sin(Date.now()/200)*2, 0, Math.PI*2);
        octx.fillStyle = 'black';
        octx.fill();

        // Text proses...
        octx.fillStyle = 'black';
        octx.font = '30px sans-serif';
        let dots = '.'.repeat((Math.floor(Date.now()/500)%3)+1);
        octx.fillText(`Sedang proses${dots}`, overlay.width/2, overlay.height/2);

        // Countdown
        octx.font = '20px sans-serif';
        octx.fillText(`Selesai dalam ${countdown}s`, overlay.width/2, overlay.height/2 + 30);

        ctx.drawImage(overlay,0,0);

    }, 100);

    const countdownTimer = setInterval(() => {
        countdown--;
        if (countdown <= 0) {
            clearInterval(countdownTimer);
            clearInterval(interval);
            saveHD();
        }
    }, 1000);
});

function saveHD() {
    const exportCanvas = document.createElement('canvas');
    exportCanvas.width = 3000;
    exportCanvas.height = 3000;
    const exportCtx = exportCanvas.getContext('2d');
    exportCtx.drawImage(img, originX, originY, img.width*scale, img.height*scale);
    exportCtx.drawImage(twibbon, 0, 0, exportCanvas.width, exportCanvas.height);

    const link = document.createElement('a');
    link.download = 'twibbon.png';
    link.href = exportCanvas.toDataURL('image/png');
    link.click();

    shareBtn.style.display = 'inline-block';
    resetBtn.style.display = 'inline-block';
    downloadBtn.style.display = 'none';
}

resetBtn.addEventListener('click', () => {
    img = null;
    scale = 1;
    originX = originY = 0;
    placeholderText.style.display = 'block';
    downloadBtn.disabled = true;
    downloadBtn.style.display = 'inline-block';
    shareBtn.style.display = 'none';
    resetBtn.style.display = 'none';
    draw();
});

</script>
</body>
</html>

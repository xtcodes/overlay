<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>PFP Twibbon</title>
<style>
    body {
        font-family: sans-serif;
        background: #f0f0f0;
        margin: 0;
        padding: 20px;
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 15px;
    }
    .drop-area {
        width: 100%;
        max-width: 400px;
        aspect-ratio: 1/1;
        border: 2px dashed #aaa;
        background: #fff;
        display: flex;
        align-items: center;
        justify-content: center;
        position: relative;
        overflow: hidden;
        border-radius: 10px;
    }
    .drop-area.hover {
        background: #f8f8f8;
        border-color: #555;
    }
    canvas {
        position: absolute;
        top: 0;
        left: 0;
    }
    input[type=file] {
        display: none;
    }
    /*
    .btn-group {
        display: flex;
        gap: 10px;
    }
    button {
        padding: 8px 15px;
        font-size: 14px;
        border: none;
        border-radius: 5px;
        cursor: pointer;
    }
    button:disabled {
        background: #ccc;
        cursor: not-allowed;
    }
    #btnDownload { background: #007bff; color: white; width: 100%; }
    #btnShare { background: #28a745; color: white; }
    #btnReset { background: #dc3545; color: white; }
    */

    .btn-group {
        display: flex;
        gap: 10px;
        width: 100%;
        max-width: 400px;
    }
    button {
        padding: 10px;
        font-size: 15px;
        border: none;
        border-radius: 5px;
        cursor: pointer;
        flex: 1;
    }
    button:disabled {
        background: #ccc;
        cursor: not-allowed;
    }
    #btnDownload { background: #007bff; color: white; width: 100%; }
    #btnShare { background: #28a745; color: white; }
    #btnReset { background: #dc3545; color: white; }

</style>
</head>
<body>

<div class="drop-area" id="dropArea">
    <input type="file" id="fileInput" accept="image/*">
    <canvas id="canvas"></canvas>
</div>
<!--
<div class="btn-group">
    <button id="btnDownload" disabled>Unduh</button>
    <button id="btnShare" style="display:none;">Bagikan</button>
    <button id="btnReset" style="display:none;">Reset</button>
</div>
-->

<div class="btn-group" id="downloadGroup">
    <button id="btnDownload" disabled>Unduh</button>
</div>
    
<div class="btn-group" id="shareResetGroup" style="display:none;">
    <button id="btnShare">Bagikan</button>
    <button id="btnReset">Reset</button>
</div>
    
<script>
const dropArea = document.getElementById('dropArea');
const fileInput = document.getElementById('fileInput');
const canvas = document.getElementById('canvas');
const ctx = canvas.getContext('2d');

const btnDownload = document.getElementById('btnDownload');
const btnShare = document.getElementById('btnShare');
const btnReset = document.getElementById('btnReset');

let userImage = null;
let twibbonImage = new Image();
let placeholderImage = new Image();
let scale = 1;
let offsetX = 0, offsetY = 0;
let lastTouchDistance = null;
let lastTouchX = null, lastTouchY = null;
let isDragging = false;
let isInteracting = false;

twibbonImage.src = "twibbon.png"; // ganti path twibbon
placeholderImage.src = "placeholder.png"; // ganti path placeholder

window.addEventListener('load', () => {
    initCanvas();
    drawPlaceholder();
});

// === Event upload ===
dropArea.addEventListener('click', () => fileInput.click());
dropArea.addEventListener('dragover', e => {
    e.preventDefault();
    dropArea.classList.add('hover');
});
dropArea.addEventListener('dragleave', () => dropArea.classList.remove('hover'));
dropArea.addEventListener('drop', e => {
    e.preventDefault();
    dropArea.classList.remove('hover');
    handleFile(e.dataTransfer.files[0]);
});
fileInput.addEventListener('change', e => handleFile(e.target.files[0]));

function handleFile(file) {
    if (!file || !file.type.startsWith('image/')) return;
    const reader = new FileReader();
    reader.onload = () => {
        userImage = new Image();
        userImage.onload = () => {
            initCanvas();
            draw();
            fileInput.disabled = true;
            btnDownload.disabled = false; // aktifkan tombol unduh
        };
        userImage.src = reader.result;
    };
    reader.readAsDataURL(file);
}

function initCanvas() {
    canvas.width = dropArea.clientWidth;
    canvas.height = dropArea.clientHeight;
    offsetX = 0;
    offsetY = 0;
    scale = 1;
}

function drawPlaceholder() {
    ctx.clearRect(0, 0, canvas.width, canvas.height);
    ctx.drawImage(placeholderImage, 0, 0, canvas.width, canvas.height);
}

function draw() {
    ctx.clearRect(0, 0, canvas.width, canvas.height);
    if (userImage) {
        let imgW = userImage.width * scale;
        let imgH = userImage.height * scale;
        let x = canvas.width/2 - imgW/2 + offsetX;
        let y = canvas.height/2 - imgH/2 + offsetY;
        ctx.drawImage(userImage, x, y, imgW, imgH);
        ctx.globalAlpha = isInteracting ? 0.5 : 1;
        ctx.drawImage(twibbonImage, 0, 0, canvas.width, canvas.height);
        ctx.globalAlpha = 1;
    } else {
        drawPlaceholder();
    }
}

// === Gesture handling ===
canvas.addEventListener('touchstart', e => {
    if (!userImage) return;
    if (e.touches.length === 1) {
        isDragging = true;
        lastTouchX = e.touches[0].clientX;
        lastTouchY = e.touches[0].clientY;
    } else if (e.touches.length === 2) {
        lastTouchDistance = getDistance(e.touches[0], e.touches[1]);
    }
    isInteracting = true;
    draw();
});

canvas.addEventListener('touchmove', e => {
    if (!userImage) return;
    e.preventDefault();
    if (e.touches.length === 1 && isDragging) {
        let dx = e.touches[0].clientX - lastTouchX;
        let dy = e.touches[0].clientY - lastTouchY;
        offsetX += dx;
        offsetY += dy;
        lastTouchX = e.touches[0].clientX;
        lastTouchY = e.touches[0].clientY;
    } else if (e.touches.length === 2) {
        let newDistance = getDistance(e.touches[0], e.touches[1]);
        if (lastTouchDistance) {
            scale *= newDistance / lastTouchDistance;
        }
        lastTouchDistance = newDistance;
    }
    draw();
}, { passive: false });

canvas.addEventListener('touchend', e => {
    if (!userImage) return;
    if (e.touches.length === 0) {
        isDragging = false;
        isInteracting = false;
        draw();
    }
});

function getDistance(touch1, touch2) {
    let dx = touch2.clientX - touch1.clientX;
    let dy = touch2.clientY - touch1.clientY;
    return Math.sqrt(dx*dx + dy*dy);
}

// === Tombol aksi ===
// btnDownload.addEventListener('click', () => {
//    if (!userImage) return;
//    const link = document.createElement('a');
//    link.download = "twibbon.png";
//    link.href = canvas.toDataURL("image/png");
//    link.click();
//    btnDownload.style.display = "none";
//    btnShare.style.display = "inline-block";
//    btnReset.style.display = "inline-block";
// });

    btnDownload.addEventListener('click', () => {
    if (!userImage) return;
    const link = document.createElement('a');
    link.download = "twibbon.png";
    link.href = canvas.toDataURL("image/png");
    link.click();

    document.getElementById('downloadGroup').style.display = "none";
    document.getElementById('shareResetGroup').style.display = "flex";
});


btnShare.addEventListener('click', async () => {
    try {
        const blob = await new Promise(resolve => canvas.toBlob(resolve));
        await navigator.share({
            title: 'Twibbon Saya',
            files: [new File([blob], 'twibbon.png', { type: 'image/png' })]
        });
    } catch (err) {
        alert("Gagal membagikan gambar.");
    }
});

btnReset.addEventListener('click', () => {
    userImage = null;
    fileInput.value = "";
    fileInput.disabled = false;
    btnDownload.disabled = true;
    btnDownload.style.display = "inline-block";
    btnShare.style.display = "none";
    btnReset.style.display = "none";
    initCanvas();
    drawPlaceholder();
});
</script>

</body>
</html>

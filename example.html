<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Twibbon PFP Responsive</title>
<style>
    body {
        font-family: Arial, sans-serif;
        margin: 0;
        background: #f5f5f5;
        display: flex;
        flex-direction: column;
        align-items: center;
        padding: 10px;
    }
    h1 {
        text-align: center;
        font-size: 1.5em;
    }
    .drop-area {
        position: relative;
        width: 100%;
        max-width: 400px;
        aspect-ratio: 1 / 1;
        border: 2px dashed #bbb;
        border-radius: 10px;
        background: white;
        display: flex;
        align-items: center;
        justify-content: center;
        overflow: hidden;
    }
    .drop-area input {
        display: none;
    }
    canvas {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        touch-action: none;
    }
    .placeholder {
        text-align: center;
        color: #999;
        pointer-events: none;
        font-size: 1em;
        padding: 10px;
    }
    .btn-container {
        margin-top: 15px;
        width: 100%;
        max-width: 400px;
        display: flex;
        flex-direction: column;
        gap: 10px;
    }
    button {
        padding: 10px;
        font-size: 1em;
        border: none;
        border-radius: 5px;
        cursor: pointer;
    }
    .btn-unduh {
        background: #4CAF50;
        color: white;
        width: 100%;
    }
    .btn-bagikan {
        background: #2196F3;
        color: white;
        flex: 1;
    }
    .btn-reset {
        background: #f44336;
        color: white;
        flex: 1;
    }
    .row {
        display: flex;
        gap: 10px;
        width: 100%;
    }
</style>
</head>
<body>

<h1>Twibbon Profile Picture</h1>

<div class="drop-area" id="dropArea">
    <input type="file" id="uploadImage" accept="image/*">
    <canvas id="canvas"></canvas>
    <div class="placeholder" id="placeholderText">Tarik & letakkan gambar atau klik untuk unggah</div>
</div>

<div class="btn-container">
    <button class="btn-unduh" id="downloadBtn" disabled>Unduh</button>
    <div class="row" id="afterDownload" style="display:none;">
        <button class="btn-bagikan" id="shareBtn">Bagikan</button>
        <button class="btn-reset" id="resetBtn">Reset</button>
    </div>
</div>

<script>
const dropArea = document.getElementById('dropArea');
const uploadImage = document.getElementById('uploadImage');
const placeholderText = document.getElementById('placeholderText');
const canvas = document.getElementById('canvas');
const ctx = canvas.getContext('2d');
const downloadBtn = document.getElementById('downloadBtn');
const afterDownload = document.getElementById('afterDownload');
const shareBtn = document.getElementById('shareBtn');
const resetBtn = document.getElementById('resetBtn');

let userImage = null;
let twibbonImage = new Image();
let scale = 1, posX = 0, posY = 0;
let lastX, lastY, isDragging = false;
let lastDistance = 0;
let twibbonOpacity = 1;

twibbonImage.src = "twibbon.png"; // ganti sesuai file twibbon kamu

function resizeCanvas() {
    canvas.width = dropArea.clientWidth;
    canvas.height = dropArea.clientHeight;
    drawCanvas();
}

window.addEventListener('resize', resizeCanvas);
resizeCanvas();

function drawCanvas() {
    ctx.clearRect(0, 0, canvas.width, canvas.height);
    if (userImage) {
        ctx.save();
        ctx.translate(canvas.width/2 + posX, canvas.height/2 + posY);
        ctx.scale(scale, scale);
        ctx.drawImage(userImage, -userImage.width/2, -userImage.height/2);
        ctx.restore();
        ctx.globalAlpha = twibbonOpacity;
        ctx.drawImage(twibbonImage, 0, 0, canvas.width, canvas.height);
        ctx.globalAlpha = 1;
    } else {
        // placeholder saja
    }
}

dropArea.addEventListener('click', () => {
    if (!userImage) uploadImage.click();
});

uploadImage.addEventListener('change', e => {
    const file = e.target.files[0];
    if (!file) return;
    const img = new Image();
    img.onload = () => {
        userImage = img;
        placeholderText.style.display = 'none';
        downloadBtn.disabled = false;
        scale = Math.min(canvas.width / img.width, canvas.height / img.height);
        posX = posY = 0;
        drawCanvas();
    };
    img.src = URL.createObjectURL(file);
});

dropArea.addEventListener('dragover', e => {
    e.preventDefault();
    dropArea.style.borderColor = '#4CAF50';
});
dropArea.addEventListener('dragleave', () => {
    dropArea.style.borderColor = '#bbb';
});
dropArea.addEventListener('drop', e => {
    e.preventDefault();
    dropArea.style.borderColor = '#bbb';
    const file = e.dataTransfer.files[0];
    if (!file) return;
    const img = new Image();
    img.onload = () => {
        userImage = img;
        placeholderText.style.display = 'none';
        downloadBtn.disabled = false;
        scale = Math.min(canvas.width / img.width, canvas.height / img.height);
        posX = posY = 0;
        drawCanvas();
    };
    img.src = URL.createObjectURL(file);
});

// Geser dan Zoom
canvas.addEventListener('touchstart', e => {
    if (!userImage) return;
    if (e.touches.length === 1) {
        isDragging = true;
        lastX = e.touches[0].clientX;
        lastY = e.touches[0].clientY;
        twibbonOpacity = 0.5;
    } else if (e.touches.length === 2) {
        lastDistance = getDistance(e.touches[0], e.touches[1]);
        twibbonOpacity = 0.5;
    }
});
canvas.addEventListener('touchmove', e => {
    if (!userImage) return;
    e.preventDefault();
    if (e.touches.length === 1 && isDragging) {
        posX += e.touches[0].clientX - lastX;
        posY += e.touches[0].clientY - lastY;
        lastX = e.touches[0].clientX;
        lastY = e.touches[0].clientY;
    } else if (e.touches.length === 2) {
        let newDistance = getDistance(e.touches[0], e.touches[1]);
        scale *= newDistance / lastDistance;
        lastDistance = newDistance;
    }
    drawCanvas();
}, { passive: false });
canvas.addEventListener('touchend', () => {
    isDragging = false;
    twibbonOpacity = 1;
    drawCanvas();
});

canvas.addEventListener('wheel', e => {
    if (!userImage) return;
    e.preventDefault();
    twibbonOpacity = 0.5;
    scale += e.deltaY * -0.001;
    scale = Math.min(Math.max(0.1, scale), 5);
    drawCanvas();
    clearTimeout(wheelTimeout);
    wheelTimeout = setTimeout(() => {
        twibbonOpacity = 1;
        drawCanvas();
    }, 200);
}, { passive: false });

let wheelTimeout;

function getDistance(touch1, touch2) {
    return Math.hypot(touch2.clientX - touch1.clientX, touch2.clientY - touch1.clientY);
}

// Unduh
downloadBtn.addEventListener('click', () => {
    if (!userImage) return;
    const link = document.createElement('a');
    link.download = 'twibbon.png';
    link.href = canvas.toDataURL('image/png', 1.0);
    link.click();
    downloadBtn.style.display = 'none';
    afterDownload.style.display = 'flex';
});

// Bagikan
shareBtn.addEventListener('click', async () => {
    const blob = await (await fetch(canvas.toDataURL('image/png'))).blob();
    if (navigator.share) {
        navigator.share({
            files: [new File([blob], 'twibbon.png', { type: 'image/png' })],
            title: 'Twibbon Saya'
        });
    }
});

// Reset
resetBtn.addEventListener('click', () => {
    userImage = null;
    placeholderText.style.display = 'block';
    downloadBtn.style.display = 'block';
    afterDownload.style.display = 'none';
    downloadBtn.disabled = true;
    ctx.clearRect(0, 0, canvas.width, canvas.height);
});
</script>

</body>
</html>

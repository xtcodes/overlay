<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Twibbon PFP</title>
<style>
  body { font-family: Arial, sans-serif; margin: 0; padding: 0; text-align: center; background: #f0f0f0; }
  #drop-area { border: 2px dashed #ccc; padding: 10px; width: 100%; max-width: 400px; margin: 20px auto; background: white; position: relative; }
  canvas { width: 100%; height: auto; display: block; background: #e0e0e0; }
  #placeholder { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); color: #888; pointer-events: none; }
  button { padding: 10px; font-size: 16px; margin-top: 10px; cursor: pointer; }
  .btn-container { display: flex; gap: 10px; justify-content: center; flex-wrap: wrap; }
  .btn-full { width: 100%; }
  .hidden { display: none; }
</style>
</head>
<body>

<h2>Twibbon PFP</h2>
<div id="drop-area">
  <canvas id="canvas" width="1080" height="1080"></canvas>
  <div id="placeholder">Tarik & Letakkan Gambar di Sini</div>
  <input type="file" id="fileInput" accept="image/*" hidden>
</div>

<div class="btn-container">
  <button id="downloadBtn" class="btn-full" disabled>Unduh</button>
  <button id="shareBtn" class="hidden">Bagikan</button>
  <button id="resetBtn" class="hidden">Reset</button>
</div>

<script>
const canvas = document.getElementById('canvas');
const ctx = canvas.getContext('2d');
const placeholder = document.getElementById('placeholder');
const fileInput = document.getElementById('fileInput');
const dropArea = document.getElementById('drop-area');

const downloadBtn = document.getElementById('downloadBtn');
const shareBtn = document.getElementById('shareBtn');
const resetBtn = document.getElementById('resetBtn');

let userImage = null;
let twibbonImage = new Image();
let twibbonOpacity = 1;
let isDragging = false;
let lastX, lastY;
let scale = 1, startDistance = 0, posX = 0, posY = 0;

// Load twibbon (default overlay)
twibbonImage.src = 'twibbon.png';

function drawCanvas() {
  ctx.clearRect(0, 0, canvas.width, canvas.height);

  // Jika belum ada gambar, tampilkan placeholder
  if (!userImage) {
    return;
  }

  ctx.save();
  ctx.translate(posX, posY);
  ctx.scale(scale, scale);
  ctx.drawImage(userImage, 0, 0);
  ctx.restore();

  ctx.globalAlpha = twibbonOpacity;
  ctx.drawImage(twibbonImage, 0, 0, canvas.width, canvas.height);
  ctx.globalAlpha = 1;
}

function setUserImage(img) {
  userImage = img;
  placeholder.style.display = 'none';
  posX = posY = 0;
  scale = 1;
  drawCanvas();
  downloadBtn.disabled = false;
}

dropArea.addEventListener('click', () => {
  fileInput.click();
});

fileInput.addEventListener('change', e => {
  if (e.target.files.length) {
    const file = e.target.files[0];
    const img = new Image();
    img.onload = () => setUserImage(img);
    img.src = URL.createObjectURL(file);
  }
});

// Geser & zoom
canvas.addEventListener('touchstart', e => {
  if (!userImage) return;
  if (e.touches.length === 1) {
    isDragging = true;
    lastX = e.touches[0].clientX;
    lastY = e.touches[0].clientY;
    twibbonOpacity = 0.5;
  } else if (e.touches.length === 2) {
    startDistance = Math.hypot(
      e.touches[0].clientX - e.touches[1].clientX,
      e.touches[0].clientY - e.touches[1].clientY
    );
    twibbonOpacity = 0.5;
  }
});

canvas.addEventListener('touchmove', e => {
  if (!userImage) return;
  if (e.touches.length === 1 && isDragging) {
    const dx = e.touches[0].clientX - lastX;
    const dy = e.touches[0].clientY - lastY;
    posX += dx;
    posY += dy;
    lastX = e.touches[0].clientX;
    lastY = e.touches[0].clientY;
    drawCanvas();
  } else if (e.touches.length === 2) {
    const newDistance = Math.hypot(
      e.touches[0].clientX - e.touches[1].clientX,
      e.touches[0].clientY - e.touches[1].clientY
    );
    const zoom = newDistance / startDistance;
    scale *= zoom;
    startDistance = newDistance;
    drawCanvas();
  }
});

canvas.addEventListener('touchend', e => {
  isDragging = false;
  twibbonOpacity = 1;
  drawCanvas();
});

// Unduh
downloadBtn.addEventListener('click', () => {
  if (!userImage) return;
  const link = document.createElement('a');
  link.download = 'twibbon.png';
  link.href = canvas.toDataURL('image/png', 1.0);
  link.click();
  downloadBtn.classList.add('hidden');
  shareBtn.classList.remove('hidden');
  resetBtn.classList.remove('hidden');
});

// Bagikan
shareBtn.addEventListener('click', async () => {
  if (navigator.share) {
    const blob = await new Promise(resolve => canvas.toBlob(resolve));
    const file = new File([blob], 'twibbon.png', { type: 'image/png' });
    await navigator.share({ files: [file], title: 'Twibbon PFP' });
  } else {
    alert('Fitur bagikan tidak didukung di browser ini.');
  }
});

// Reset
resetBtn.addEventListener('click', () => {
  userImage = null;
  placeholder.style.display = 'block';
  downloadBtn.disabled = true;
  downloadBtn.classList.remove('hidden');
  shareBtn.classList.add('hidden');
  resetBtn.classList.add('hidden');
  drawCanvas();
});
</script>

</body>
</html>

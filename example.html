<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Twibbon PFP HD</title>
<style>
    body {
        margin: 0; font-family: sans-serif; background: #f4f4f4;
        display: flex; flex-direction: column; align-items: center; padding: 10px;
    }
    .container {
        max-width: 500px; width: 100%;
    }
    #dropArea {
        border: 2px dashed #aaa;
        border-radius: 10px;
        position: relative;
        width: 100%;
        padding-top: 100%; /* Square */
        background: white;
        overflow: hidden;
        touch-action: none;
    }
    canvas {
        position: absolute;
        top: 0; left: 0;
        width: 100%; height: 100%;
    }
    .placeholder {
        position: absolute;
        top: 50%; left: 50%;
        transform: translate(-50%, -50%);
        text-align: center; color: #999;
        font-size: 16px;
        pointer-events: none;
    }
    .controls {
        margin-top: 10px;
        display: flex; gap: 10px;
        flex-wrap: wrap;
    }
    button {
        padding: 10px; border: none; border-radius: 5px;
        font-size: 16px; cursor: pointer;
    }
    .full { width: 100%; }
    .half { flex: 1; }
    .hidden { display: none; }
</style>
</head>
<body>
<div class="container">
    <div id="dropArea">
        <canvas id="mainCanvas"></canvas>
        <div id="placeholder" class="placeholder">Tarik & letakkan gambar<br>atau klik untuk unggah</div>
        <input type="file" id="fileInput" accept="image/*" style="display:none">
    </div>
    <div class="controls">
        <button id="downloadBtn" class="full" disabled>Unduh</button>
        <button id="shareBtn" class="half hidden">Bagikan</button>
        <button id="resetBtn" class="half hidden">Reset</button>
    </div>
</div>

<script>
const dropArea = document.getElementById('dropArea');
const fileInput = document.getElementById('fileInput');
const placeholder = document.getElementById('placeholder');
const canvas = document.getElementById('mainCanvas');
const ctx = canvas.getContext('2d');
const downloadBtn = document.getElementById('downloadBtn');
const shareBtn = document.getElementById('shareBtn');
const resetBtn = document.getElementById('resetBtn');

let userImg = null;
let twibbonImg = new Image();
twibbonImg.src = "twibbon.png"; // ganti dengan file twibbon transparan
let offsetX = 0, offsetY = 0, scale = 1;
let isDragging = false, lastX, lastY, lastDist;
let twibbonAlpha = 1;

function resizeCanvas() {
    canvas.width = dropArea.clientWidth;
    canvas.height = dropArea.clientHeight;
    draw();
}

function draw() {
    ctx.clearRect(0, 0, canvas.width, canvas.height);
    if (userImg) {
        ctx.drawImage(userImg, offsetX, offsetY, userImg.width * scale, userImg.height * scale);
        ctx.globalAlpha = twibbonAlpha;
        ctx.drawImage(twibbonImg, 0, 0, canvas.width, canvas.height);
        ctx.globalAlpha = 1;
    }
}

function toHDImage() {
    const size = 2000; // resolusi HD
    const offCanvas = document.createElement('canvas');
    offCanvas.width = size;
    offCanvas.height = size;
    const offCtx = offCanvas.getContext('2d');
    if (userImg) {
        const scaleRatio = size / canvas.width;
        offCtx.drawImage(userImg, offsetX * scaleRatio, offsetY * scaleRatio, userImg.width * scale * scaleRatio, userImg.height * scale * scaleRatio);
        offCtx.drawImage(twibbonImg, 0, 0, size, size);
    }
    return offCanvas.toDataURL("image/png");
}

function resetAll() {
    userImg = null;
    offsetX = offsetY = 0;
    scale = 1;
    placeholder.classList.remove('hidden');
    downloadBtn.disabled = true;
    downloadBtn.classList.remove('hidden');
    shareBtn.classList.add('hidden');
    resetBtn.classList.add('hidden');
    draw();
}

dropArea.addEventListener('click', () => fileInput.click());
fileInput.addEventListener('change', handleFiles);
dropArea.addEventListener('dragover', e => { e.preventDefault(); dropArea.style.borderColor = '#333'; });
dropArea.addEventListener('dragleave', e => { dropArea.style.borderColor = '#aaa'; });
dropArea.addEventListener('drop', e => {
    e.preventDefault();
    dropArea.style.borderColor = '#aaa';
    if (e.dataTransfer.files.length) handleFiles({ target: { files: e.dataTransfer.files } });
});

function handleFiles(e) {
    const file = e.target.files[0];
    if (!file) return;
    const reader = new FileReader();
    reader.onload = evt => {
        userImg = new Image();
        userImg.onload = () => {
            placeholder.classList.add('hidden');
            downloadBtn.disabled = false;
            draw();
        };
        userImg.src = evt.target.result;
    };
    reader.readAsDataURL(file);
}

canvas.addEventListener('mousedown', e => {
    isDragging = true; lastX = e.clientX; lastY = e.clientY;
});
canvas.addEventListener('mousemove', e => {
    if (isDragging && userImg) {
        offsetX += e.clientX - lastX;
        offsetY += e.clientY - lastY;
        lastX = e.clientX; lastY = e.clientY;
        twibbonAlpha = 0.5;
        draw();
    }
});
canvas.addEventListener('mouseup', () => { isDragging = false; twibbonAlpha = 1; draw(); });

canvas.addEventListener('touchstart', e => {
    if (e.touches.length === 1) {
        isDragging = true;
        lastX = e.touches[0].clientX;
        lastY = e.touches[0].clientY;
    } else if (e.touches.length === 2) {
        lastDist = Math.hypot(
            e.touches[0].clientX - e.touches[1].clientX,
            e.touches[0].clientY - e.touches[1].clientY
        );
    }
});
canvas.addEventListener('touchmove', e => {
    e.preventDefault();
    if (userImg) {
        if (e.touches.length === 1 && isDragging) {
            offsetX += e.touches[0].clientX - lastX;
            offsetY += e.touches[0].clientY - lastY;
            lastX = e.touches[0].clientX;
            lastY = e.touches[0].clientY;
            twibbonAlpha = 0.5;
        } else if (e.touches.length === 2) {
            const dist = Math.hypot(
                e.touches[0].clientX - e.touches[1].clientX,
                e.touches[0].clientY - e.touches[1].clientY
            );
            scale *= dist / lastDist;
            lastDist = dist;
            twibbonAlpha = 0.5;
        }
        draw();
    }
});
canvas.addEventListener('touchend', () => { isDragging = false; twibbonAlpha = 1; draw(); });

downloadBtn.addEventListener('click', () => {
    const link = document.createElement('a');
    link.download = "twibbon.png";
    link.href = toHDImage();
    link.click();
    downloadBtn.classList.add('hidden');
    shareBtn.classList.remove('hidden');
    resetBtn.classList.remove('hidden');
});
resetBtn.addEventListener('click', resetAll);

window.addEventListener('resize', resizeCanvas);
resizeCanvas();
</script>
</body>
</html>

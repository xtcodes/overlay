
<!DOCTYPE html>

<html lang="id">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1.0" name="viewport"/>
<title>Twibbon Generator</title>
<style>
    body {
      font-family: sans-serif;
      text-align: center;
      margin: 0;
      padding: 0;
    }
    #canvasWrapper {
      position: relative;
      width: 100%;
      max-width: 400px;
      margin: 20px auto;
      border: 2px dashed #aaa;
      background: #eee;
    }
    canvas {
      width: 100%;
      touch-action: none;
    }
    #twibbonUploadBtn {
      position: absolute;
      top: 10px;
      left: 10px;
      z-index: 5;
    }
    #processOverlay {
      display: none;
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-color: rgba(0, 0, 0, 0.5);
      backdrop-filter: blur(3px);
      color: white;
      font-size: 16px;
      justify-content: center;
      align-items: center;
      z-index: 10;
      flex-direction: row;
      gap: 10px;
    }
    #spinner {
      border: 4px solid #f3f3f3;
      border-top: 4px solid #fff;
      border-radius: 50%;
      width: 24px;
      height: 24px;
      animation: spin 1s linear infinite;
    }
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    #fileInput {
      display: none;
    }
    #customUploadBtn {
      margin-top: 10px;
    }
    #altDownloadLink {
      display: none;
      margin-top: 10px;
    }
  </style>
<style>
/* Spinner dan blur */
#canvasContainer.processing canvas {
    filter: blur(5px);
    background-color: rgba(128, 128, 128, 0.6);
}

#processingOverlay {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    font-size: 18px;
    display: flex;
    align-items: center;
    gap: 10px;
    background: rgba(0, 0, 0, 0.5);
    padding: 10px 15px;
    border-radius: 8px;
    color: white;
    z-index: 9999;
}

.spinner {
    width: 18px;
    height: 18px;
    border: 3px solid #fff;
    border-top: 3px solid transparent;
    border-radius: 50%;
    animation: spin 1s linear infinite;
}

@keyframes spin {
    to { transform: rotate(360deg); }
}

#downloadAlternative {
    margin-top: 15px;
    display: none;
    color: red;
    text-align: center;
    font-size: 14px;
}
</style></head>
<body>
<div id="canvasWrapper">
<button id="twibbonUploadBtn">Ubah Twibbon</button>
<canvas height="800" id="canvas" width="800"></canvas>
<div id="processOverlay">
<div id="spinner"></div>
<span>Sedang proses...</span>
</div>
</div>
<input accept="image/*" id="fileInput" type="file"/>
<button id="customUploadBtn">Unggah Gambar</button>
<button id="downloadBtn" style="display:none;">Unduh Hasil Twibbon</button>
<button id="shareBtn" style="display:none;">Bagikan</button>
<div id="altDownloadLink"><a download="twibbon.png" href="#">Klik di sini jika unduhan tidak dimulai</a></div>
<script>
    const canvas = document.getElementById("canvas");
    const ctx = canvas.getContext("2d");
    const fileInput = document.getElementById("fileInput");
    const uploadBtn = document.getElementById("customUploadBtn");
    const twibbonUploadBtn = document.getElementById("twibbonUploadBtn");
    const downloadBtn = document.getElementById("downloadBtn");
    const shareBtn = document.getElementById("shareBtn");
    const processOverlay = document.getElementById("processOverlay");
    const altDownloadLink = document.getElementById("altDownloadLink");

    let userImage = null;
    let twibbonImage = new Image();
    twibbonImage.src = "twibbon-default.png";

    let scale = 1;
    let originX = 0;
    let originY = 0;
    let lastTouch = null;
    let dragging = false;

    function drawCanvas() {
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      if (userImage) {
        ctx.save();
        ctx.translate(canvas.width / 2 + originX, canvas.height / 2 + originY);
        ctx.scale(scale, scale);
        ctx.drawImage(userImage, -userImage.width / 2, -userImage.height / 2);
        ctx.restore();
      }
      if (twibbonImage.complete) {
        if (dragging || lastTouch) {
          ctx.globalAlpha = 0.5;
        } else {
          ctx.globalAlpha = 1.0;
        }
        ctx.drawImage(twibbonImage, 0, 0, canvas.width, canvas.height);
        ctx.globalAlpha = 1.0;
      }
    }

    uploadBtn.addEventListener("click", () => fileInput.click());

    fileInput.addEventListener("change", (e) => {
      const file = e.target.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = () => {
        userImage = new Image();
        userImage.onload = () => {
          originX = 0;
          originY = 0;
          scale = 1;
          drawCanvas();
          downloadBtn.style.display = "inline-block";
          shareBtn.style.display = "none";
        };
        userImage.src = reader.result;
      };
      reader.readAsDataURL(file);
    });

    let lastDist = null;
    canvas.addEventListener("touchstart", (e) => {
      if (e.touches.length === 1) {
        lastTouch = e.touches[0];
        dragging = true;
      } else if (e.touches.length === 2) {
        lastDist = getDistance(e.touches);
      }
    });

    canvas.addEventListener("touchmove", (e) => {
      e.preventDefault();
      if (e.touches.length === 1 && dragging) {
        const touch = e.touches[0];
        const dx = touch.clientX - lastTouch.clientX;
        const dy = touch.clientY - lastTouch.clientY;
        originX += dx;
        originY += dy;
        lastTouch = touch;
        drawCanvas();
      } else if (e.touches.length === 2) {
        const dist = getDistance(e.touches);
        if (lastDist) {
          const zoom = dist / lastDist;
          scale *= zoom;
          lastDist = dist;
          drawCanvas();
        }
      }
    }, { passive: false });

    canvas.addEventListener("touchend", (e) => {
      if (e.touches.length < 2) lastDist = null;
      if (e.touches.length === 0) dragging = false;
    });

    function getDistance(touches) {
      const dx = touches[0].clientX - touches[1].clientX;
      const dy = touches[0].clientY - touches[1].clientY;
      return Math.sqrt(dx * dx + dy * dy);
    }

    downloadBtn.addEventListener("click", () => {
      processOverlay.style.display = "flex";
      setTimeout(() => {
        const tempCanvas = document.createElement("canvas");
        tempCanvas.width = canvas.width;
        tempCanvas.height = canvas.height;
        const tempCtx = tempCanvas.getContext("2d");
        tempCtx.fillStyle = "#fff";
        tempCtx.fillRect(0, 0, tempCanvas.width, tempCanvas.height);
        tempCtx.drawImage(canvas, 0, 0);
        const link = document.createElement("a");
        link.download = "twibbon.png";
        link.href = tempCanvas.toDataURL();
        link.click();
        altDownloadLink.style.display = "block";
        processOverlay.style.display = "none";
        downloadBtn.style.display = "none";
        shareBtn.style.display = "inline-block";
      }, 15000);
    });

    shareBtn.addEventListener("click", async () => {
      if (navigator.share) {
        const blob = await (await fetch(canvas.toDataURL())).blob();
        const file = new File([blob], "twibbon.png", { type: blob.type });
        try {
          await navigator.share({
            files: [file],
            title: "Twibbon Saya",
            text: "Lihat hasil twibbon saya!",
          });
        } catch (err) {
          alert("Gagal membagikan: " + err.message);
        }
      } else {
        alert("Web Share API tidak didukung di browser ini.");
      }
    });

    twibbonUploadBtn.addEventListener("click", () => {
      const input = document.createElement("input");
      input.type = "file";
      input.accept = "image/*";
      input.onchange = (e) => {
        const file = e.target.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = () => {
          const img = new Image();
          img.onload = () => {
            // Validasi transparansi
            const testCanvas = document.createElement("canvas");
            const testCtx = testCanvas.getContext("2d");
            testCanvas.width = img.width;
            testCanvas.height = img.height;
            testCtx.drawImage(img, 0, 0);
            const pixels = testCtx.getImageData(0, 0, img.width, img.height).data;
            let hasAlpha = false;
            for (let i = 3; i < pixels.length; i += 4) {
              if (pixels[i] < 255) {
                hasAlpha = true;
                break;
              }
            }
            if (!hasAlpha) {
              alert("Twibbon harus memiliki bagian transparan (format PNG).");
              return;
            }
            twibbonImage = img;
            drawCanvas();
          };
          img.src = reader.result;
        };
        reader.readAsDataURL(file);
      };
      input.click();
    });

    twibbonImage.onload = drawCanvas;
  </script>
<div id="processingOverlay" style="display:none;"><div class="spinner"></div><span>Sedang proses...</span></div><div id="downloadAlternative">Jika unduhan tidak dimulai secara otomatis, klik di sini untuk mengunduh secara manual.</div><script>
document.getElementById("downloadBtn").addEventListener("click", function () {
    const canvas = document.querySelector("canvas");
    const overlay = document.getElementById("processingOverlay");
    const container = document.getElementById("canvasContainer");
    const downloadBtn = document.getElementById("downloadBtn");
    const altLink = document.getElementById("downloadAlternative");

    // Aktifkan efek blur
    container.classList.add("processing");
    overlay.style.display = "flex";
    downloadBtn.disabled = true;

    let countdown = 15;

    const interval = setInterval(() => {
        countdown--;
        if (countdown <= 0) {
            clearInterval(interval);

            // Reset efek
            container.classList.remove("processing");
            overlay.style.display = "none";
            downloadBtn.disabled = false;

            // Lanjutkan unduh otomatis
            const link = document.createElement("a");
            link.download = "twibbon.png";
            link.href = canvas.toDataURL();
            link.click();

            // Tampilkan tautan alternatif
            altLink.style.display = "block";
            altLink.innerHTML = '<a href="' + link.href + '" download="twibbon.png">Klik di sini jika unduhan gagal</a>';
        }
    }, 1000);
});
</script></body>
</html>

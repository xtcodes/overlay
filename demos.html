<!doctype html>
<html lang="id">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Alat Twibbon - Final</title>

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" crossorigin="anonymous" />

<style>
  body{margin:0;padding:20px;background:#f3f4f6;font-family:system-ui,Segoe UI,Roboto,"Helvetica Neue",Arial;display:flex;justify-content:center;align-items:flex-start;min-height:100vh;}
  .wrap{width:100%;max-width:700px;background:#fff;border-radius:10px;padding:12px;box-shadow:0 4px 12px rgba(0,0,0,0.08);}
  .canvas-area{position:relative;width:100%;padding-top:100%;background:#e5e7eb;border-radius:8px;overflow:hidden;touch-action:none;}
  #mainCanvas,#fxCanvas{position:absolute;inset:0;width:100%;height:100%;}
  #mainCanvas{z-index:10;} #fxCanvas{z-index:20;pointer-events:none;}
  .overlay{position:absolute;inset:0;background:rgba(0,0,0,0.45);display:flex;justify-content:center;align-items:center;color:#fff;font-size:16px;font-weight:600;gap:10px;z-index:60;display:none;}
  .control-panel{position:absolute;bottom:12px;left:12px;z-index:70;display:flex;gap:8px;background:rgba(0,0,0,0.55);padding:8px;border-radius:8px;backdrop-filter: blur(4px);}
  .btn{width:40px;height:40px;border:none;border-radius:6px;background:rgba(255,255,255,0.12);color:#fff;cursor:pointer;display:flex;align-items:center;justify-content:center;font-size:18px;}
  input[type=file]{display:none;}
  .alt-link{margin-top:14px;font-size:15px;color:#333;}
  .alt-link a{color:#2196F3;text-decoration:underline;}
  .download{margin-top:12px;display:flex;width:100%;justify-content:flex-end;gap:10px;align-items:center;}
  .primary{padding:8px 14px;border-radius:6px;border:0;cursor:pointer;font-size:14px;color:#fff;}
  .process-btn{background:#4CAF50;}
  .share-btn{background:#2196F3;}
  .reset-btn{background:#f44336;}
  .spinner{border:4px solid rgba(255,255,255,0.25);border-top:4px solid #fff;border-radius:50%;width:22px;height:22px;animation:spin 1s linear infinite;}
  @keyframes spin{to{transform:rotate(360deg);}}
</style>
</head>
<body>
<div class="wrap">
  <h3 style="margin:6px 0 12px">Alat Twibbon (Upload Hilang Setelah Proses)</h3>

  <div class="canvas-area" id="canvasArea">
    <canvas id="mainCanvas"></canvas>
    <canvas id="fxCanvas"></canvas>
    <div class="overlay" id="overlay"><div class="spinner"></div><div>Proses...</div></div>
    <div class="control-panel" id="uploadPanel">
      <button class="btn" id="photoBtn" title="Unggah Foto"><i class="fa-solid fa-image"></i></button>
      <input id="photoInput" type="file" accept="image/*" />
      <button class="btn" id="frameBtn" title="Unggah Twibbon"><i class="fa-solid fa-layer-group"></i></button>
      <input id="frameInput" type="file" accept="image/png,image/*" />
    </div>
  </div>

  <!-- tombol Proses -->
  <div id="processBox" class="download" style="display:none">
    <button id="processBtn" class="primary process-btn">Proses</button>
  </div>

  <!-- link alternatif -->
  <p id="altLinkContainer" class="alt-link" style="display:none">
    Jika unduh tidak dimulai otomatis, <a id="altDownloadLink" href="#" download="twibbon.png">klik disini</a>
  </p>

  <!-- tombol bagikan & reset -->
  <div id="downloadBox" class="download" style="display:none">
    <button id="shareBtn" class="primary share-btn" style="display:none">Bagikan</button>
    <button id="resetBtn" class="primary reset-btn" style="display:none">Reset</button>
  </div>
</div>

<script>
const $=id=>document.getElementById(id);
const mainCanvas=$('mainCanvas'),ctx=mainCanvas.getContext('2d');
const fxCanvas=$('fxCanvas'),ctxFX=fxCanvas.getContext('2d');
const canvasArea=$('canvasArea');let DPR=window.devicePixelRatio||1;
let photoImg=null,frameImg=null,offsetX=0,offsetY=0,scale=1,isEditing=false,isDragging=false,lastX=0,lastY=0,lastTouchDist=0,isLocked=false;
let exportBlob=null,exportURL=null;

/* resize & draw */
function resizeCanvas(){const rect=canvasArea.getBoundingClientRect();const cssSize=rect.width;DPR=window.devicePixelRatio||1;[mainCanvas,fxCanvas].forEach(c=>{c.style.width=cssSize+'px';c.style.height=cssSize+'px';c.width=Math.round(cssSize*DPR);c.height=Math.round(cssSize*DPR);});draw();}
function drawPlaceholder(){ctx.save();ctx.fillStyle="#9ca3af";let fontSize=Math.floor(mainCanvas.width*0.05);fontSize=Math.max(14,Math.min(32,fontSize));ctx.font=`${fontSize}px system-ui,sans-serif`;ctx.textAlign="center";ctx.textBaseline="middle";ctx.fillText("Unggah Foto dan Twibbon untuk Memulai",mainCanvas.width/2,mainCanvas.height/2);ctx.restore();}
function draw(){ctx.clearRect(0,0,mainCanvas.width,mainCanvas.height);const cW=mainCanvas.width,cH=mainCanvas.height;if(photoImg){const baseScale=Math.max(cW/photoImg.width,cH/photoImg.height);const ds=baseScale*scale;const w=photoImg.width*ds,h=photoImg.height*ds;const x=(cW-w)/2+offsetX,y=(cH-h)/2+offsetY;ctx.drawImage(photoImg,x,y,w,h);}if(frameImg){ctx.globalAlpha=isEditing?0.5:1.0;ctx.drawImage(frameImg,0,0,cW,cH);ctx.globalAlpha=1.0;}if(!photoImg&&!frameImg)drawPlaceholder();updateProcessVisibility();}
function hasTransparency(img){const t=document.createElement('canvas'),c=t.getContext('2d');t.width=img.width;t.height=img.height;c.drawImage(img,0,0);const d=c.getImageData(0,0,img.width,img.height).data;for(let i=3;i<d.length;i+=4){if(d[i]<255)return true;}return false;}
function updateProcessVisibility(){$('processBox').style.display=(photoImg&&frameImg)?'flex':'none';}

/* upload */
$('photoBtn').onclick=()=>$('photoInput').click();
$('frameBtn').onclick=()=>$('frameInput').click();
$('photoInput').addEventListener('change',e=>{const f=e.target.files[0];if(!f)return;const url=URL.createObjectURL(f);const img=new Image();img.onload=()=>{photoImg=img;offsetX=offsetY=0;scale=1;draw();URL.revokeObjectURL(url);};img.src=url;});
$('frameInput').addEventListener('change',e=>{const f=e.target.files[0];if(!f)return;const url=URL.createObjectURL(f);const img=new Image();img.onload=()=>{if(hasTransparency(img)){frameImg=img;draw();}else{alert("⚠️ Twibbon harus PNG dengan area transparan.");frameImg=null;draw();}URL.revokeObjectURL(url);};img.src=url;});

/* export */
function exportTwibbonBlob(cb){const tmp=document.createElement('canvas');tmp.width=mainCanvas.width;tmp.height=mainCanvas.height;const tctx=tmp.getContext('2d');const cW=tmp.width,cH=tmp.height;if(photoImg){const baseScale=Math.max(cW/photoImg.width,cH/photoImg.height);const ds=baseScale*scale;const w=photoImg.width*ds,h=photoImg.height*ds;const x=(cW-w)/2+offsetX,y=(cH-h)/2+offsetY;tctx.drawImage(photoImg,x,y,w,h);}if(frameImg){tctx.drawImage(frameImg,0,0,cW,cH);}tmp.toBlob(cb,'image/png');}
function processExport(){const overlay=$('overlay');overlay.style.display='flex';isLocked=true;$('uploadPanel').style.display='none';
setTimeout(()=>{exportTwibbonBlob(blob=>{exportBlob=blob;if(exportURL)URL.revokeObjectURL(exportURL);exportURL=URL.createObjectURL(blob);$('altLinkContainer').style.display='block';$('altDownloadLink').href=exportURL;$('shareBtn').style.display='inline-block';$('resetBtn').style.display='inline-block';$('downloadBox').style.display='flex';overlay.style.display='none';$('processBox').style.display='none';isLocked=false;triggerSequenceFireworks();});},2000);}
$('processBtn').onclick=processExport;

/* share */
$('shareBtn').addEventListener('click',async()=>{if(!exportBlob){alert("Proses dulu sebelum bagikan.");return;}const file=new File([exportBlob],"twibbon.png",{type:"image/png"});if(navigator.share&&navigator.canShare?.({files:[file]})){try{await navigator.share({title:"Twibbon",text:"Lihat twibbon saya!",files:[file]});}catch(e){console.log("Share batal:",e);} } else alert("Fitur share tidak didukung.");});

/* reset */
$('resetBtn').addEventListener('click',()=>{photoImg=frameImg=null;offsetX=offsetY=0;scale=1;isEditing=isDragging=false;lastX=lastY=lastTouchDist=0;isLocked=false;exportBlob=null;if(exportURL){URL.revokeObjectURL(exportURL);exportURL=null;}$('photoInput').value='';$('frameInput').value='';$('uploadPanel').style.display='flex';$('shareBtn').style.display='none';$('resetBtn').style.display='none';$('downloadBox').style.display='none';$('altLinkContainer').style.display='none';$('processBox').style.display='none';draw();particles=[];if(animId){cancelAnimationFrame(animId);animId=null;}ctxFX.clearRect(0,0,fxCanvas.width,fxCanvas.height);});

/* geser & zoom */
function getDist(t1,t2){return Math.hypot(t2.clientX-t1.clientX,t2.clientY-t1.clientY);}
mainCanvas.addEventListener('pointerdown',e=>{if(isLocked||e.pointerType==='touch')return;isDragging=true;lastX=e.clientX;lastY=e.clientY;isEditing=true;mainCanvas.setPointerCapture?.(e.pointerId);});
mainCanvas.addEventListener('pointermove',e=>{if(isLocked||!isDragging||e.pointerType==='touch')return;const dx=(e.clientX-lastX)*DPR,dy=(e.clientY-lastY)*DPR;offsetX+=dx;offsetY+=dy;lastX=e.clientX;lastY=e.clientY;draw();});
mainCanvas.addEventListener('pointerup',e=>{if(e.pointerType==='touch')return;isDragging=false;isEditing=false;mainCanvas.releasePointerCapture?.(e.pointerId);draw();});
mainCanvas.addEventListener('touchstart',e=>{if(isLocked)return;if(e.touches.length===2){lastTouchDist=getDist(e.touches[0],e.touches[1]);isEditing=true;}else if(e.touches.length===1){lastX=e.touches[0].clientX;lastY=e.touches[0].clientY;isEditing=true;}},{passive:false});
mainCanvas.addEventListener('touchmove',e=>{if(isLocked)return;if(e.touches.length===2){const dist=getDist(e.touches[0],e.touches[1]);if(lastTouchDist>0){scale*=dist/lastTouchDist;scale=Math.max(0.2,Math.min(5,scale));}lastTouchDist=dist;draw();}else if(e.touches.length===1){const dx=(e.touches[0].clientX-lastX)*DPR,dy=(e.touches[0].clientY-lastY)*DPR;offsetX+=dx;offsetY+=dy;lastX=e.touches[0].clientX;lastY=e.touches[0].clientY;draw();}e.preventDefault();},{passive:false});
mainCanvas.addEventListener('touchend',e=>{if(isLocked)return;if(e.touches.length===0){isEditing=false;lastTouchDist=0;draw();}});
mainCanvas.addEventListener('wheel',e=>{if(isLocked)return;isEditing=true;scale*=(e.deltaY<0?1.08:0.92);scale=Math.max(0.2,Math.min(5,scale));draw();clearTimeout(mainCanvas._wheelTimeout);mainCanvas._wheelTimeout=setTimeout(()=>{isEditing=false;draw();},300);e.preventDefault();},{passive:false});

/* fireworks */
let particles=[],animId=null;
function createParticles(x,y,count=140){for(let i=0;i<count;i++){const a=Math.random()*2*Math.PI;const s=Math.random()*5+2;particles.push({x,y,vx:Math.cos(a)*s,vy:Math.sin(a)*s-(Math.random()*2),r:Math.random()*3+1.5,color:`hsl(${Math.random()*360},100%,50%)`,life:Math.random()*60+30,gravity:0.12+Math.random()*0.18,friction:0.995});}}
function updateParticles(){for(const p of particles){p.vx*=p.friction;p.vy+=p.gravity;p.x+=p.vx;p.y+=p.vy;p.life--;}particles=particles.filter(p=>p.life>0);}
function drawParticles(){ctxFX.clearRect(0,0,fxCanvas.width,fxCanvas.height);for(const p of particles){ctxFX.beginPath();ctxFX.arc(p.x,p.y,p.r,0,Math.PI*2);ctxFX.fillStyle=p.color;ctxFX.fill();}}
function animateParticles(){if(animId)cancelAnimationFrame(animId);function loop(){if(particles.length>0){updateParticles();drawParticles();animId=requestAnimationFrame(loop);}else{ctxFX.clearRect(0,0,fxCanvas.width,fxCanvas.height);if(animId){cancelAnimationFrame(animId);animId=null;}}}loop();}
function triggerSequenceFireworks(){const w=fxCanvas.width,h=fxCanvas.height;[[w/2,h/2],[w*0.12,h*0.12],[w*0.88,h*0.12],[w*0.12,h*0.88],[w*0.88,h*0.88]].forEach((p,i)=>{setTimeout(()=>{createParticles(p[0],p[1]);animateParticles();},i*1000);});}

/* init */
window.addEventListener('resize',resizeCanvas);resizeCanvas();
</script>
</body>
</html>

<!doctype html>
<html lang="id">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Alat Twibbon Final</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" crossorigin="anonymous" />
<style>
  body{
    margin:0; padding:20px; background:#f3f4f6;
    font-family:sans-serif; display:flex; justify-content:center; align-items:flex-start; min-height:100vh;
  }
  .wrap{width:100%; max-width:600px; background:#fff; border-radius:10px; padding:12px; box-shadow:0 4px 12px rgba(0,0,0,0.1);}
  .canvas-area{position:relative; width:100%; padding-top:100%; background:#e5e7eb; border-radius:8px; overflow:hidden;}
  canvas{position:absolute; inset:0; width:100%; height:100%;}
  #fxCanvas{pointer-events:none;}
  .overlay{position:absolute; inset:0; background:rgba(0,0,0,0.6); display:none; justify-content:center; align-items:center; color:#fff; font-size:16px; font-weight:500; gap:10px; z-index:20;}
  .control-panel{position:absolute; bottom:12px; left:12px; display:flex; gap:8px; background:rgba(0,0,0,0.6); padding:8px; border-radius:8px; backdrop-filter:blur(4px);}
  .btn{width:40px; height:40px; border:none; border-radius:6px; background:rgba(255,255,255,0.15); color:#fff; cursor:pointer; display:flex; align-items:center; justify-content:center; font-size:18px;}
  input[type=file]{display:none}
  .download{margin-top:12px; display:flex; justify-content:flex-end; gap:10px;}
  .download button{padding:8px 14px; border:none; border-radius:6px; background:#4CAF50; color:#fff; font-size:14px; cursor:pointer;}
  .share-btn{background:#2196F3 !important;}
  .reset-btn{background:#f44336 !important;}
  .spinner{border:4px solid rgba(255,255,255,0.3); border-top:4px solid #fff; border-radius:50%; width:22px; height:22px; animation:spin 1s linear infinite;}
  @keyframes spin{0%{transform:rotate(0deg)}100%{transform:rotate(360deg)}}
  #altLinkContainer{display:none; margin-top:10px; font-size:16px; text-align:center;}
  #altLinkContainer a{color:#2196F3; text-decoration:underline;}
</style>
</head>
<body>
<div class="wrap">
  <h3 style="margin:6px 0 12px">Alat Twibbon Final</h3>
  <div class="canvas-area" id="canvasArea">
    <canvas id="mainCanvas"></canvas>
    <canvas id="fxCanvas"></canvas>
    <div class="overlay" id="overlay">
      <div class="spinner"></div><div>Sedang proses...</div>
    </div>
    <div class="control-panel" id="uploadPanel">
      <button class="btn" id="photoBtn" title="Unggah Foto"><i class="fa-solid fa-image"></i></button>
      <input id="photoInput" type="file" accept="image/*">
      <button class="btn" id="frameBtn" title="Unggah Twibbon"><i class="fa-solid fa-layer-group"></i></button>
      <input id="frameInput" type="file" accept="image/png,image/*">
    </div>
  </div>

  <!-- link alternatif unduhan -->
  <div id="altLinkContainer">
    Jika unduh tidak dimulai otomatis, <a id="altDownloadLink" href="#" download="twibbon.png">klik disini</a>
  </div>

  <!-- tombol proses -->
  <div id="processBox" style="margin-top:12px; text-align:right;">
    <button id="processBtn" style="padding:8px 14px; border:none; border-radius:6px; background:#673ab7; color:#fff; font-size:14px; cursor:pointer;">Proses</button>
  </div>

  <!-- tombol share & reset -->
  <div class="download" id="downloadBox" style="display:none;">
    <button id="shareBtn" class="share-btn" style="display:none">Bagikan</button>
    <button id="resetBtn" class="reset-btn" style="display:none">Reset</button>
  </div>
</div>

<script>
const $=id=>document.getElementById(id);
const canvas=$('mainCanvas'),ctx=canvas.getContext('2d');
const fxCanvas=$('fxCanvas'),ctxFX=fxCanvas.getContext('2d');
const container=$('canvasArea');
let DPR=window.devicePixelRatio||1;
let photoImg=null,frameImg=null,exportBlob=null,exportURL=null;
let offsetX=0,offsetY=0,scale=1,isDragging=false,isLocked=false,lastX=0,lastY=0,lastTouchDist=0,isEditing=false;

function resizeCanvas(){
  const rect=container.getBoundingClientRect(),css=rect.width;
  DPR=window.devicePixelRatio||1;
  [canvas,fxCanvas].forEach(c=>{
    c.style.width=css+'px'; c.style.height=css+'px'; c.width=css*DPR; c.height=css*DPR;
  });
  draw();
}
function draw(){
  ctx.clearRect(0,0,canvas.width,canvas.height);
  const cW=canvas.width,cH=canvas.height;
  if(photoImg){
    const base=Math.max(cW/photoImg.width,cH/photoImg.height);
    const drawScale=base*scale,w=photoImg.width*drawScale,h=photoImg.height*drawScale;
    const x=(cW-w)/2+offsetX,y=(cH-h)/2+offsetY;
    ctx.drawImage(photoImg,x,y,w,h);
  }
  if(frameImg){
    ctx.globalAlpha=isEditing?0.5:1.0;
    ctx.drawImage(frameImg,0,0,cW,cH);
    ctx.globalAlpha=1;
  }
  if(!photoImg && !frameImg) drawPlaceholder();
}
function drawPlaceholder(){
  ctx.save();
  ctx.fillStyle="#9ca3af";
  let fontSize=Math.floor(canvas.width*0.05);
  fontSize=Math.max(14,Math.min(28,fontSize));
  ctx.font=fontSize+"px sans-serif";
  ctx.textAlign="center"; ctx.textBaseline="middle";
  ctx.fillText("Unggah Foto dan Twibbon untuk Memulai",canvas.width/2,canvas.height/2);
  ctx.restore();
}
function hasTransparency(img){
  const t=document.createElement("canvas"),c=t.getContext("2d");
  t.width=img.width;t.height=img.height;c.drawImage(img,0,0);
  const d=c.getImageData(0,0,img.width,img.height).data;
  for(let i=3;i<d.length;i+=4){ if(d[i]<255) return true;}
  return false;
}
$('photoBtn').onclick=()=>$('photoInput').click();
$('frameBtn').onclick=()=>$('frameInput').click();
$('photoInput').addEventListener('change',e=>{
  const f=e.target.files[0]; if(!f) return;
  const url=URL.createObjectURL(f),img=new Image();
  img.onload=()=>{photoImg=img; offsetX=offsetY=0; scale=1; draw(); URL.revokeObjectURL(url);};
  img.src=url;
});
$('frameInput').addEventListener('change',e=>{
  const f=e.target.files[0]; if(!f) return;
  const url=URL.createObjectURL(f),img=new Image();
  img.onload=()=>{
    if(hasTransparency(img)){frameImg=img; draw();}
    else{alert("⚠️ Twibbon harus transparan!"); frameImg=null; draw();}
    URL.revokeObjectURL(url);
  };
  img.src=url;
});
function exportTwibbonBlob(cb){canvas.toBlob(cb);}
$('processBtn').onclick=processExport;
function processExport(){
  const overlay=$('overlay');
  overlay.style.display='flex'; isLocked=true; $('uploadPanel').style.display='none';
  setTimeout(()=>{
    exportTwibbonBlob(blob=>{
      exportBlob=blob; if(exportURL) URL.revokeObjectURL(exportURL);
      exportURL=URL.createObjectURL(blob);
      $('altLinkContainer').style.display='block'; $('altDownloadLink').href=exportURL;
      $('shareBtn').style.display='inline-block'; $('resetBtn').style.display='inline-block'; $('downloadBox').style.display='flex';
      overlay.style.display='none'; $('processBox').style.display='none';
      isLocked=true; triggerSequenceFireworks();
    });
  },2000);
}
$('shareBtn').onclick=()=>{
  if(!exportBlob) return;
  const file=new File([exportBlob],"twibbon.png",{type:"image/png"});
  if(navigator.share && navigator.canShare?.({files:[file]})){
    navigator.share({title:"Twibbon",files:[file]}).catch(()=>{});
  }else alert("Fitur share tidak didukung.");
};
$('resetBtn').onclick=()=>window.location.reload();

// ---- Gesture (dicegah jika isLocked) ----
function getDist(t1,t2){const dx=t2.clientX-t1.clientX,dy=t2.clientY-t1.clientY;return Math.hypot(dx,dy);}
canvas.addEventListener('pointerdown',e=>{if(isLocked)return;isDragging=true;lastX=e.clientX;lastY=e.clientY;isEditing=true;canvas.setPointerCapture(e.pointerId);});
canvas.addEventListener('pointermove',e=>{if(isLocked)return;if(isDragging&&e.pointerType==="mouse"){offsetX+=(e.clientX-lastX)*DPR;offsetY+=(e.clientY-lastY)*DPR;lastX=e.clientX;lastY=e.clientY;draw();}});
canvas.addEventListener('pointerup',e=>{if(isLocked)return;isDragging=false;isEditing=false;canvas.releasePointerCapture(e.pointerId);draw();});
canvas.addEventListener('touchstart',e=>{if(isLocked)return;if(e.touches.length===2){lastTouchDist=getDist(e.touches[0],e.touches[1]);isEditing=true;}else if(e.touches.length===1){lastX=e.touches[0].clientX;lastY=e.touches[0].clientY;isEditing=true;}},{passive:false});
canvas.addEventListener('touchmove',e=>{if(isLocked)return;if(e.touches.length===2){const dist=getDist(e.touches[0],e.touches[1]);if(lastTouchDist>0){scale*=dist/lastTouchDist;scale=Math.max(0.2,Math.min(5,scale));}lastTouchDist=dist;draw();}else if(e.touches.length===1){offsetX+=(e.touches[0].clientX-lastX)*DPR;offsetY+=(e.touches[0].clientY-lastY)*DPR;lastX=e.touches[0].clientX;lastY=e.touches[0].clientY;draw();}},{passive:false});
canvas.addEventListener('touchend',e=>{if(isLocked)return;if(e.touches.length===0){isEditing=false;draw();}});
canvas.addEventListener('wheel',e=>{if(isLocked)return;isEditing=true;scale*=(e.deltaY<0?1.1:0.9);scale=Math.max(0.2,Math.min(5,scale));draw();clearTimeout(canvas._wheelTimeout);canvas._wheelTimeout=setTimeout(()=>{isEditing=false;draw();},400);});

// ---- Fireworks ----
let particles=[],animId=null;
function createParticles(x,y){for(let i=0;i<120;i++){const angle=Math.random()*2*Math.PI,speed=Math.random()*6+2;particles.push({x,y,vx:Math.cos(angle)*speed,vy:Math.sin(angle)*speed-(Math.random()*2),r:Math.random()*3+2,color:`hsl(${Math.random()*360},100%,50%)`,life:Math.random()*60+40,g:0.15+Math.random()*0.2,f:0.99});}}
function updateParticles(){for(const p of particles){p.vx*=p.f; p.vy+=p.g; p.x+=p.vx; p.y+=p.vy; p.life--; }particles=particles.filter(p=>p.life>0);}
function drawParticles(){ctxFX.clearRect(0,0,fxCanvas.width,fxCanvas.height);for(const p of particles){ctxFX.beginPath();ctxFX.arc(p.x,p.y,p.r,0,Math.PI*2);ctxFX.fillStyle=p.color;ctxFX.fill();}}
function animateParticles(){if(animId)cancelAnimationFrame(animId);function loop(){if(particles.length>0){updateParticles();drawParticles();animId=requestAnimationFrame(loop);}else{ctxFX.clearRect(0,0,fxCanvas.width,fxCanvas.height);if(animId)cancelAnimationFrame(animId);animId=null;}}loop();}
function triggerSequenceFireworks(){const w=fxCanvas.width,h=fxCanvas.height;const pts=[[w/2,h/2],[w*0.2,h*0.2],[w*0.8,h*0.2],[w*0.2,h*0.8],[w*0.8,h*0.8]];pts.forEach((pt,i)=>{setTimeout(()=>{createParticles(pt[0],pt[1]);animateParticles();},i*1000);});}

window.addEventListener('resize',resizeCanvas);resizeCanvas();
</script>
</body>
</html>

<!doctype html>
<html lang="id">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Alat Twibbon 1x1 + Gesture + Validasi</title>

<!-- Font Awesome -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" crossorigin="anonymous" />

<style>
  body{
    margin:0;
    padding:20px;
    background:#f3f4f6;
    font-family:sans-serif;
    display:flex;
    justify-content:center;
    align-items:flex-start;
    min-height:100vh;
  }
  .wrap{
    width:100%;
    max-width:600px;
    background:#fff;
    border-radius:10px;
    padding:12px;
    box-shadow:0 4px 12px rgba(0,0,0,0.1);
  }
  .canvas-area{
    position:relative;
    width:100%;
    padding-top:100%; /* 1:1 square */
    background:#e5e7eb;
    border-radius:8px;
    overflow:hidden;
    touch-action:none;
  }
  canvas{
    position:absolute;
    inset:0;
    width:100%;
    height:100%;
  }
  .control-panel{
    position:absolute;
    bottom:12px;
    left:12px;
    display:flex;
    gap:8px;
    background:rgba(0,0,0,0.6);
    padding:8px;
    border-radius:8px;
    backdrop-filter:blur(4px);
  }
  .btn{
    width:40px;
    height:40px;
    border:none;
    border-radius:6px;
    background:rgba(255,255,255,0.15);
    color:#fff;
    cursor:pointer;
    display:flex;
    align-items:center;
    justify-content:center;
    font-size:18px;
  }
  input[type=file]{display:none}
  .download{
    margin-top:12px;
    display:flex;
    justify-content:flex-end;
  }
  .download button{
    padding:8px 14px;
    border:none;
    border-radius:6px;
    background:#4CAF50;
    color:#fff;
    font-size:14px;
    cursor:pointer;
  }
</style>
</head>
<body>
  <div class="wrap">
    <h3 style="margin:6px 0 12px">Alat Twibbon 1:1 + Gesture + Validasi</h3>
    <div class="canvas-area" id="canvasArea">
      <canvas id="mainCanvas"></canvas>

      <div class="control-panel">
        <!-- Tombol unggah foto -->
        <button class="btn" id="photoBtn" title="Unggah Foto">
          <i class="fa-solid fa-image"></i>
        </button>
        <input id="photoInput" type="file" accept="image/*">

        <!-- Tombol unggah twibbon -->
        <button class="btn" id="frameBtn" title="Unggah Twibbon">
          <i class="fa-solid fa-layer-group"></i>
        </button>
        <input id="frameInput" type="file" accept="image/png,image/*">
      </div>
    </div>
    <div class="download">
      <button id="downloadBtn">Unduh PNG</button>
    </div>
  </div>

<script>
const $ = id => document.getElementById(id);
const canvas = $('mainCanvas');
const ctx = canvas.getContext('2d');
const container = document.getElementById('canvasArea');
let DPR = window.devicePixelRatio || 1;

let photoImg = null;
let frameImg = null;

// transform foto
let offsetX = 0, offsetY = 0;
let scale = 1;
let lastTouchDist = 0;
let isDragging = false;
let isEditing = false; // flag untuk transparansi twibbon
let lastX = 0, lastY = 0;

function resizeCanvas(){
  const rect = container.getBoundingClientRect();
  const cssSize = rect.width; // square
  DPR = window.devicePixelRatio || 1;
  canvas.style.width = cssSize + 'px';
  canvas.style.height = cssSize + 'px';
  canvas.width = cssSize * DPR;
  canvas.height = cssSize * DPR;
  draw();
}

function draw(){
  ctx.clearRect(0,0,canvas.width,canvas.height);
  const cW = canvas.width;
  const cH = canvas.height;

  if(photoImg){
    const baseScale = Math.max(cW/photoImg.width, cH/photoImg.height);
    const drawScale = baseScale * scale;
    const w = photoImg.width*drawScale;
    const h = photoImg.height*drawScale;
    const x = (cW-w)/2 + offsetX;
    const y = (cH-h)/2 + offsetY;
    ctx.drawImage(photoImg, x, y, w, h);
  }
  if(frameImg){
    ctx.globalAlpha = isEditing ? 0.5 : 1.0; // transparan saat edit
    ctx.drawImage(frameImg,0,0,cW,cH);
    ctx.globalAlpha = 1.0;
  }
}

// cek apakah gambar punya transparansi
function validateTransparency(img){
  const testCanvas = document.createElement("canvas");
  const tctx = testCanvas.getContext("2d");
  testCanvas.width = img.width;
  testCanvas.height = img.height;
  tctx.drawImage(img,0,0);
  const data = tctx.getImageData(0,0,img.width,img.height).data;
  let hasTransparent = false;
  for(let i=3;i<data.length;i+=4){
    if(data[i] < 255){ // alpha kurang dari 255
      hasTransparent = true;
      break;
    }
  }
  if(!hasTransparent){
    alert("⚠️ Twibbon harus memiliki bidang transparan (PNG dengan alpha)!");
  }
}

function startEdit(){
  isEditing = true;
  draw();
}
function endEdit(){
  isEditing = false;
  draw();
}

// pointer drag
canvas.addEventListener('pointerdown', e=>{
  isDragging = true;
  lastX = e.clientX;
  lastY = e.clientY;
  startEdit();
  canvas.setPointerCapture(e.pointerId);
});
canvas.addEventListener('pointermove', e=>{
  if(isDragging && e.pointerType==="mouse"){
    offsetX += (e.clientX - lastX)*DPR;
    offsetY += (e.clientY - lastY)*DPR;
    lastX = e.clientX;
    lastY = e.clientY;
    draw();
  }
});
canvas.addEventListener('pointerup', e=>{
  isDragging = false;
  endEdit();
  canvas.releasePointerCapture(e.pointerId);
});

// pinch zoom (touch)
canvas.addEventListener('touchstart', e=>{
  if(e.touches.length===2){
    lastTouchDist = getDist(e.touches[0], e.touches[1]);
    startEdit();
  } else if(e.touches.length===1){
    lastX = e.touches[0].clientX;
    lastY = e.touches[0].clientY;
    startEdit();
  }
},{passive:false});

canvas.addEventListener('touchmove', e=>{
  if(e.touches.length===2){
    const dist = getDist(e.touches[0], e.touches[1]);
    if(lastTouchDist>0){
      const factor = dist/lastTouchDist;
      scale *= factor;
      scale = Math.max(0.2, Math.min(5, scale));
    }
    lastTouchDist = dist;
    draw();
  } else if(e.touches.length===1){
    offsetX += (e.touches[0].clientX - lastX)*DPR;
    offsetY += (e.touches[0].clientY - lastY)*DPR;
    lastX = e.touches[0].clientX;
    lastY = e.touches[0].clientY;
    draw();
  }
},{passive:false});

canvas.addEventListener('touchend', e=>{
  if(e.touches.length===0){
    endEdit();
  }
});

// mouse wheel zoom
canvas.addEventListener('wheel', e=>{
  startEdit();
  const delta = e.deltaY<0 ? 1.1 : 0.9;
  scale *= delta;
  scale = Math.max(0.2, Math.min(5, scale));
  draw();
  clearTimeout(canvas._wheelTimeout);
  canvas._wheelTimeout = setTimeout(endEdit, 400);
});

// helper jarak
function getDist(t1,t2){
  const dx = t2.clientX - t1.clientX;
  const dy = t2.clientY - t1.clientY;
  return Math.hypot(dx,dy);
}

$('photoBtn').onclick = ()=> $('photoInput').click();
$('frameBtn').onclick = ()=> $('frameInput').click();

$('photoInput').addEventListener('change',(e)=>{
  const f = e.target.files[0]; if(!f) return;
  const url = URL.createObjectURL(f);
  const img = new Image();
  img.onload = ()=>{
    photoImg=img;
    offsetX=0; offsetY=0; scale=1;
    draw();
    URL.revokeObjectURL(url);
  };
  img.src = url;
});
$('frameInput').addEventListener('change',(e)=>{
  const f = e.target.files[0]; if(!f) return;
  const url = URL.createObjectURL(f);
  const img = new Image();
  img.onload = ()=>{
    frameImg=img; 
    validateTransparency(img);
    draw(); 
    URL.revokeObjectURL(url);
  };
  img.src = url;
});

$('downloadBtn').onclick=()=>{
  canvas.toBlob(blob=>{
    const a=document.createElement('a');
    a.href=URL.createObjectURL(blob);
    a.download='twibbon.png';
    a.click();
    a.remove();
  });
};

window.addEventListener('resize',resizeCanvas);
resizeCanvas();
</script>
</body>
</html>

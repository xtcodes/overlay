
<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Twibbon Generator</title>
  <style>
    body {
      font-family: sans-serif;
      text-align: center;
      margin: 0;
      padding: 0;
    }
    #canvasContainer {
      position: relative;
      margin: 20px auto;
      border: 2px dashed #ccc;
      width: 90vw;
      max-width: 400px;
      height: 400px;
      background: #eee;
      overflow: hidden;
    }
    canvas {
      width: 100%;
      height: 100%;
      touch-action: none;
    }
    #uploadContainer {
      margin: 10px;
    }
    #uploadBtn, #twibbonInput, #downloadBtn, #shareBtn {
      margin: 10px;
      padding: 10px 20px;
    }
    #twibbonInput {
      position: absolute;
      top: 10px;
      left: 10px;
      z-index: 10;
    }
    #processOverlay {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(200, 200, 200, 0.5);
      display: flex;
      align-items: center;
      justify-content: center;
      flex-direction: row;
      font-size: 18px;
      font-weight: bold;
      z-index: 20;
      backdrop-filter: blur(5px);
      display: none;
    }
    .spinner {
      border: 4px solid #f3f3f3;
      border-top: 4px solid #444;
      border-radius: 50%;
      width: 24px;
      height: 24px;
      animation: spin 1s linear infinite;
      margin-right: 10px;
    }
    @keyframes spin {
      0% { transform: rotate(0deg);}
      100% { transform: rotate(360deg);}
    }
    #downloadLink {
      display: none;
      margin-top: 10px;
      font-size: 14px;
    }
  </style>
</head>
<body>
  <h2>Generator Twibbon</h2>

  <div id="canvasContainer">
    <canvas id="canvas" width="400" height="400"></canvas>
    <div id="processOverlay">
      <div class="spinner"></div>
      <div>Sedang proses...</div>
    </div>
    <input type="file" id="twibbonInput" accept="image/png" />
  </div>

  <div id="uploadContainer">
    <input type="file" id="imageInput" accept="image/*">
    <button id="uploadBtn">Unggah Gambar</button>
  </div>

  <button id="downloadBtn" style="display:none;">Unduh Hasil Twibbon</button>
  <button id="shareBtn" style="display:none;">Bagikan</button>

  <a id="downloadLink" href="#" download="twibboned.png">Klik di sini jika unduhan tidak otomatis</a>

  <script>
    const canvas = document.getElementById('canvas');
    const ctx = canvas.getContext('2d');
    const imageInput = document.getElementById('imageInput');
    const uploadBtn = document.getElementById('uploadBtn');
    const downloadBtn = document.getElementById('downloadBtn');
    const shareBtn = document.getElementById('shareBtn');
    const twibbonInput = document.getElementById('twibbonInput');
    const overlay = document.getElementById('processOverlay');
    const downloadLink = document.getElementById('downloadLink');

    let userImage = null;
    let twibbonImage = new Image();
    let dragging = false;
    let lastX = 0;
    let lastY = 0;
    let offsetX = 0;
    let offsetY = 0;
    let scale = 1;
    let initialDistance = 0;

    // Load default twibbon
    twibbonImage.src = "twibbon-default.png";
    twibbonImage.onload = draw;

    canvas.addEventListener('touchstart', handleTouchStart, false);
    canvas.addEventListener('touchmove', handleTouchMove, false);
    canvas.addEventListener('touchend', () => dragging = false);

    function handleTouchStart(e) {
      if (e.touches.length === 1) {
        dragging = true;
        lastX = e.touches[0].clientX;
        lastY = e.touches[0].clientY;
      } else if (e.touches.length === 2) {
        initialDistance = getDistance(e.touches[0], e.touches[1]);
      }
    }

    function handleTouchMove(e) {
      e.preventDefault();
      if (e.touches.length === 1 && dragging) {
        const dx = e.touches[0].clientX - lastX;
        const dy = e.touches[0].clientY - lastY;
        offsetX += dx;
        offsetY += dy;
        lastX = e.touches[0].clientX;
        lastY = e.touches[0].clientY;
        draw(true);
      } else if (e.touches.length === 2) {
        const newDistance = getDistance(e.touches[0], e.touches[1]);
        const zoomFactor = newDistance / initialDistance;
        scale *= zoomFactor;
        initialDistance = newDistance;
        draw(true);
      }
    }

    function getDistance(touch1, touch2) {
      return Math.hypot(touch2.clientX - touch1.clientX, touch2.clientY - touch1.clientY);
    }

    function draw(translucent = false) {
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      if (userImage) {
        const iw = userImage.width * scale;
        const ih = userImage.height * scale;
        ctx.drawImage(userImage, offsetX, offsetY, iw, ih);
      }
      if (twibbonImage && twibbonImage.complete) {
        if (translucent) {
          ctx.globalAlpha = 0.5;
        } else {
          ctx.globalAlpha = 1;
        }
        ctx.drawImage(twibbonImage, 0, 0, canvas.width, canvas.height);
        ctx.globalAlpha = 1;
      }
    }

    uploadBtn.addEventListener('click', () => {
      const file = imageInput.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = function(e) {
        userImage = new Image();
        userImage.onload = () => {
          draw();
          downloadBtn.style.display = "inline-block";
          shareBtn.style.display = "none";
        };
        userImage.src = e.target.result;
      };
      reader.readAsDataURL(file);
    });

    twibbonInput.addEventListener('change', () => {
      const file = twibbonInput.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = function(e) {
        const img = new Image();
        img.onload = () => {
          // Validasi transparansi
          const tempCanvas = document.createElement('canvas');
          const tempCtx = tempCanvas.getContext('2d');
          tempCanvas.width = img.width;
          tempCanvas.height = img.height;
          tempCtx.drawImage(img, 0, 0);
          const data = tempCtx.getImageData(0, 0, img.width, img.height).data;
          let hasAlpha = false;
          for (let i = 3; i < data.length; i += 4) {
            if (data[i] < 255) {
              hasAlpha = true;
              break;
            }
          }
          if (!hasAlpha) {
            alert("Twibbon harus memiliki bagian transparan!");
            return;
          }
          twibbonImage = img;
          draw();
        };
        img.src = e.target.result;
      };
      reader.readAsDataURL(file);
    });

    downloadBtn.addEventListener('click', () => {
      overlay.style.display = "flex";
      downloadBtn.disabled = true;

      setTimeout(() => {
        overlay.style.display = "none";
        downloadBtn.disabled = false;
        const link = document.createElement('a');
        link.download = "twibboned.png";
        link.href = canvas.toDataURL();
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);

        downloadLink.href = link.href;
        downloadLink.style.display = "inline-block";
        downloadBtn.style.display = "none";
        shareBtn.style.display = "inline-block";
      }, 15000);
    });

    shareBtn.addEventListener('click', async () => {
      if (navigator.share) {
        canvas.toBlob(blob => {
          const file = new File([blob], "twibboned.png", { type: "image/png" });
          navigator.share({
            title: "Twibbon Saya",
            files: [file]
          }).catch(err => console.log("Share failed:", err));
        });
      } else {
        alert("Web Share API tidak didukung di perangkat ini.");
      }
    });
  </script>
</body>
</html>

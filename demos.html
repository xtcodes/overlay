<!doctype html>
<html lang="id">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Alat Twibbon Final</title>

<!-- Font Awesome -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" crossorigin="anonymous" />

<style>
  body{
    margin:0;
    padding:20px;
    background:#f3f4f6;
    font-family:sans-serif;
    display:flex;
    justify-content:center;
    align-items:flex-start;
    min-height:100vh;
  }
  .wrap{
    width:100%;
    max-width:600px;
    background:#fff;
    border-radius:10px;
    padding:12px;
    box-shadow:0 4px 12px rgba(0,0,0,0.1);
  }
  .canvas-area{
    position:relative;
    width:100%;
    padding-top:100%;
    background:#e5e7eb;
    border-radius:8px;
    overflow:hidden;
    touch-action:none;
  }
  canvas{
    position:absolute;
    inset:0;
    width:100%;
    height:100%;
  }
  .placeholder{
    position:absolute;
    top:50%;
    left:50%;
    transform:translate(-50%,-50%);
    font-size:clamp(14px,4vw,20px);
    color:#6b7280;
    text-align:center;
    pointer-events:none;
  }
  .overlay{
    position:absolute;
    inset:0;
    background:rgba(0,0,0,0.5);
    display:flex;
    justify-content:center;
    align-items:center;
    color:#fff;
    font-size:16px;
    font-weight:500;
    gap:10px;
    z-index:10;
    display:none;
  }
  .control-panel{
    position:absolute;
    bottom:12px;
    left:12px;
    display:flex;
    gap:8px;
    background:rgba(0,0,0,0.6);
    padding:8px;
    border-radius:8px;
    backdrop-filter:blur(4px);
  }
  .btn{
    width:40px;
    height:40px;
    border:none;
    border-radius:6px;
    background:rgba(255,255,255,0.15);
    color:#fff;
    cursor:pointer;
    display:flex;
    align-items:center;
    justify-content:center;
    font-size:18px;
  }
  input[type=file]{display:none}
  .process-box{
    margin-top:12px;
    display:none;
    justify-content:flex-end;
  }
  .process-box button{
    padding:8px 14px;
    border:none;
    border-radius:6px;
    background:#4CAF50;
    color:#fff;
    font-size:14px;
    cursor:pointer;
  }
  .alt-download{
    margin-top:12px;
    display:none;
    font-size:14px;
  }
  .download{
    margin-top:12px;
    display:none;
    justify-content:flex-end;
    gap:10px;
  }
  .download button{
    padding:8px 14px;
    border:none;
    border-radius:6px;
    background:#2196F3;
    color:#fff;
    font-size:14px;
    cursor:pointer;
  }
  .reset-btn{ background:#f44336 !important; }
  .spinner{
    border:4px solid rgba(255,255,255,0.3);
    border-top:4px solid #fff;
    border-radius:50%;
    width:22px;
    height:22px;
    animation:spin 1s linear infinite;
  }
  @keyframes spin{ 0%{transform:rotate(0)} 100%{transform:rotate(360deg)} }
</style>
</head>
<body>
  <div class="wrap">
    <h3 style="margin:6px 0 12px">Alat Twibbon (Final)</h3>
    <div class="canvas-area" id="canvasArea">
      <canvas id="mainCanvas"></canvas>
      <div class="placeholder" id="placeholder">Unggah Foto &amp; Twibbon<br>untuk mulai</div>

      <!-- Overlay spinner -->
      <div class="overlay" id="overlay">
        <div class="spinner"></div>
        <div>Memproses...</div>
      </div>

      <div class="control-panel" id="uploadPanel">
        <button class="btn" id="photoBtn" title="Unggah Foto">
          <i class="fa-solid fa-image"></i>
        </button>
        <input id="photoInput" type="file" accept="image/*">

        <button class="btn" id="frameBtn" title="Unggah Twibbon">
          <i class="fa-solid fa-layer-group"></i>
        </button>
        <input id="frameInput" type="file" accept="image/png,image/*">
      </div>
    </div>

    <!-- Link alternatif unduh -->
    <div class="alt-download" id="altLinkContainer">
      Jika unduhan tidak dimulai otomatis <a id="altDownloadLink" href="#" download="twibbon.png">klik disini</a>
    </div>

    <!-- Tombol proses -->
    <div class="process-box" id="processBox">
      <button id="processBtn">Proses</button>
    </div>

    <!-- Tombol share + reset -->
    <div class="download" id="downloadBox">
      <button id="shareBtn" style="display:none">Bagikan</button>
      <button id="resetBtn" class="reset-btn" style="display:none">Reset</button>
    </div>
  </div>

<script>
const $ = id=>document.getElementById(id);
const canvas=$('mainCanvas'), ctx=canvas.getContext('2d');
const container=$('canvasArea');
let DPR=window.devicePixelRatio||1;

let photoImg=null, frameImg=null;
let offsetX=0, offsetY=0, scale=1;
let isEditing=false,isDragging=false,lastX=0,lastY=0,lastTouchDist=0;
let isLocked=false;
let exportBlob=null,exportURL=null;

function resizeCanvas(){
  const rect=container.getBoundingClientRect();
  const cssSize=rect.width;
  DPR=window.devicePixelRatio||1;
  canvas.style.width=cssSize+'px';
  canvas.style.height=cssSize+'px';
  canvas.width=cssSize*DPR;
  canvas.height=cssSize*DPR;
  draw();
}
function draw(){
  ctx.clearRect(0,0,canvas.width,canvas.height);
  const cW=canvas.width,cH=canvas.height;
  if(photoImg){
    const baseScale=Math.max(cW/photoImg.width,cH/photoImg.height);
    const drawScale=baseScale*scale;
    const w=photoImg.width*drawScale,h=photoImg.height*drawScale;
    const x=(cW-w)/2+offsetX,y=(cH-h)/2+offsetY;
    ctx.drawImage(photoImg,x,y,w,h);
  }
  if(frameImg){
    ctx.globalAlpha=isEditing?0.5:1.0;
    ctx.drawImage(frameImg,0,0,cW,cH);
    ctx.globalAlpha=1.0;
  }
}
function hasTransparency(img){
  const t=document.createElement("canvas"),c=t.getContext("2d");
  t.width=img.width;t.height=img.height;
  c.drawImage(img,0,0);
  const d=c.getImageData(0,0,img.width,img.height).data;
  for(let i=3;i<d.length;i+=4){ if(d[i]<255) return true; }
  return false;
}
function updateUI(){
  $('placeholder').style.display=(photoImg&&frameImg)?'none':'block';
  $('processBox').style.display=(photoImg&&frameImg)?'flex':'none';
}

// unggah
$('photoBtn').onclick=()=>$('photoInput').click();
$('frameBtn').onclick=()=>$('frameInput').click();
$('photoInput').addEventListener('change',e=>{
  const f=e.target.files[0]; if(!f) return;
  const url=URL.createObjectURL(f),img=new Image();
  img.onload=()=>{ photoImg=img; offsetX=offsetY=0; scale=1; draw(); URL.revokeObjectURL(url); updateUI(); };
  img.src=url;
});
$('frameInput').addEventListener('change',e=>{
  const f=e.target.files[0]; if(!f) return;
  const url=URL.createObjectURL(f),img=new Image();
  img.onload=()=>{
    if(hasTransparency(img)){ frameImg=img; draw(); }
    else{ alert("âš ï¸ Twibbon harus transparan!"); frameImg=null; draw(); }
    URL.revokeObjectURL(url); updateUI();
  };
  img.src=url;
});

// proses export
function exportTwibbonBlob(cb){
  const temp=document.createElement('canvas');
  temp.width=canvas.width; temp.height=canvas.height;
  const tctx=temp.getContext('2d');
  const baseScale=Math.max(temp.width/photoImg.width,temp.height/photoImg.height);
  const drawScale=baseScale*scale;
  const w=photoImg.width*drawScale,h=photoImg.height*drawScale;
  const x=(temp.width-w)/2+offsetX,y=(temp.height-h)/2+offsetY;
  tctx.drawImage(photoImg,x,y,w,h);
  tctx.drawImage(frameImg,0,0,temp.width,temp.height);
  temp.toBlob(cb,'image/png');
}
function processExport(){
  const overlay=$('overlay');
  overlay.style.display='flex';
  isLocked=true;
  $('uploadPanel').style.display='none';

  setTimeout(()=>{
    exportTwibbonBlob(blob=>{
      exportBlob=blob;
      if(exportURL) URL.revokeObjectURL(exportURL);
      exportURL=URL.createObjectURL(blob);

      $('altLinkContainer').style.display='block';
      $('altDownloadLink').href=exportURL;

      $('shareBtn').style.display='inline-block';
      $('resetBtn').style.display='inline-block';
      $('downloadBox').style.display='flex';

      overlay.style.display='none';
      $('processBox').style.display='none';

      isLocked=true; // ðŸ”’ permanen
      triggerSequenceFireworks();
    });
  },2000);
}
$('processBtn').onclick=processExport;

// bagikan
$('shareBtn').onclick=()=>{
  if(!exportBlob) return;
  const file=new File([exportBlob],"twibbon.png",{type:"image/png"});
  if(navigator.share && navigator.canShare?.({files:[file]})){
    navigator.share({title:"Twibbon",files:[file]}).catch(()=>{});
  }else alert("Fitur share tidak didukung browser ini.");
};
// reset
$('resetBtn').onclick=()=>window.location.reload();

// gesture
function getDist(t1,t2){return Math.hypot(t2.clientX-t1.clientX,t2.clientY-t1.clientY);}
canvas.addEventListener('pointerdown',e=>{
  if(isLocked)return;
  isDragging=true;lastX=e.clientX;lastY=e.clientY;isEditing=true;
  canvas.setPointerCapture(e.pointerId);
});
canvas.addEventListener('pointermove',e=>{
  if(isLocked)return;
  if(isDragging && e.pointerType==="mouse"){
    e.preventDefault();
    offsetX+=(e.clientX-lastX)*DPR; offsetY+=(e.clientY-lastY)*DPR;
    lastX=e.clientX; lastY=e.clientY; draw();
  }
},{passive:false});
canvas.addEventListener('pointerup',e=>{
  if(isLocked)return;
  isDragging=false;isEditing=false;canvas.releasePointerCapture(e.pointerId);draw();
});
canvas.addEventListener('touchstart',e=>{
  if(isLocked)return;
  e.preventDefault();
  if(e.touches.length===2){lastTouchDist=getDist(e.touches[0],e.touches[1]);isEditing=true;}
  else if(e.touches.length===1){lastX=e.touches[0].clientX;lastY=e.touches[0].clientY;isEditing=true;}
},{passive:false});
canvas.addEventListener('touchmove',e=>{
  if(isLocked)return;
  e.preventDefault();
  if(e.touches.length===2){
    const dist=getDist(e.touches[0],e.touches[1]);
    if(lastTouchDist>0){scale*=dist/lastTouchDist;scale=Math.max(0.2,Math.min(5,scale));}
    lastTouchDist=dist;draw();
  }else if(e.touches.length===1){
    offsetX+=(e.touches[0].clientX-lastX)*DPR;
    offsetY+=(e.touches[0].clientY-lastY)*DPR;
    lastX=e.touches[0].clientX;lastY=e.touches[0].clientY;draw();
  }
},{passive:false});
canvas.addEventListener('touchend',e=>{
  if(isLocked)return;
  if(e.touches.length===0){isEditing=false;draw();}
});
canvas.addEventListener('wheel',e=>{
  if(isLocked)return;
  e.preventDefault();
  isEditing=true;scale*=(e.deltaY<0?1.1:0.9);scale=Math.max(0.2,Math.min(5,scale));
  draw();clearTimeout(canvas._wheelTimeout);
  canvas._wheelTimeout=setTimeout(()=>{isEditing=false;draw();},400);
},{passive:false});

// fireworks
function triggerFireworksAt(x,y,duration=1500){
  const particles=[];
  for(let i=0;i<40;i++){
    particles.push({
      x:x,y:y,
      angle:Math.random()*2*Math.PI,
      speed:2+Math.random()*3,
      life:duration,age:0,
      color:`hsl(${Math.random()*360},100%,50%)`
    });
  }
  const start=performance.now();
  function animate(now){
    const elapsed=now-start;
    ctx.save();
    ctx.globalCompositeOperation="lighter";
    particles.forEach(p=>{
      const progress=p.age/p.life;
      if(progress<1){
        p.x+=Math.cos(p.angle)*p.speed;
        p.y+=Math.sin(p.angle)*p.speed;
        ctx.fillStyle=p.color;
        ctx.globalAlpha=1-progress;
        ctx.beginPath();
        ctx.arc(p.x,p.y,2,0,2*Math.PI);
        ctx.fill();
        p.age=elapsed;
      }
    });
    ctx.restore();
    if(elapsed<duration) requestAnimationFrame(animate);
    else draw();
  }
  requestAnimationFrame(animate);
}
function triggerSequenceFireworks(){
  const positions=[
    [canvas.width/2,canvas.height/2],
    [50,50],
    [canvas.width-50,50],
    [50,canvas.height-50],
    [canvas.width-50,canvas.height-50]
  ];
  positions.forEach((pos,i)=>{
    setTimeout(()=>{triggerFireworksAt(pos[0],pos[1]);},i*600);
  });
}

window.addEventListener('resize',resizeCanvas);
resizeCanvas();
</script>
</body>
</html>

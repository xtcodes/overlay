<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Twibbon Maker</title>
  <style>
    body {margin:0;font-family:sans-serif;display:flex;flex-direction:column;height:100vh;}
    #box {flex:1;display:flex;align-items:center;justify-content:center;background:#f0f0f0;overflow:hidden;}
    canvas {max-width:100%;max-height:100%;}
    .ph {color:#888;position:absolute;pointer-events:none;}

    .bar {padding:10px;display:flex;gap:10px;justify-content:center;flex-wrap:wrap;}
    button {padding:10px 16px;font-size:16px;border:none;border-radius:6px;cursor:pointer;transition:all .3s ease;display:inline-flex;align-items:center;gap:8px;}
    button:disabled {opacity:.6;cursor:not-allowed;}

    button.primary {background:#1976d2;color:#fff;}
    button.processing {background:#fbc02d;color:#000;}
    button.done {background:#388e3c;color:#fff;}

    .fab {position:fixed;bottom:80px;right:20px;width:56px;height:56px;border-radius:50%;background:#1976d2;color:#fff;font-size:24px;display:flex;align-items:center;justify-content:center;cursor:pointer;box-shadow:0 2px 6px rgba(0,0,0,0.3);}

    .after-bar {position:fixed;bottom:0;left:0;right:0;background:#fff;border-top:1px solid #ccc;padding:10px;display:flex;gap:10px;justify-content:center;transform:translateY(100%);transition:transform .3s ease;}
    .after-bar.show {transform:translateY(0);}

    #mask {position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,.6);color:#fff;display:flex;flex-direction:column;align-items:center;justify-content:center;font-size:24px;z-index:10;display:none;}
    #mask.active {display:flex;}

    /* Spinner style */
    .spinner {
      border: 3px solid rgba(0,0,0,0.2);
      border-top: 3px solid #000;
      border-radius: 50%;
      width: 16px;
      height: 16px;
      animation: spin 1s linear infinite;
    }
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
  </style>
</head>
<body>
  <div class="bar top-bar">
    <input type="file" id="photoInput" accept="image/*" style="display:none">
    <input type="file" id="twibbonInput" accept="image/*" style="display:none">
    <button id="resetAllTop">Reset</button>
    <button id="processBtn" class="primary" disabled><span>Buat</span></button>
  </div>
  <div id="box">
    <span class="ph">Pilih foto</span>
    <canvas id="canvas"></canvas>
  </div>
  <div class="fab" id="pickerFab">ðŸ“·</div>
  <div id="mask"><div>Memproses... <span id="countNum"></span></div></div>
  <div class="after-bar" id="afterBar">
    <button id="dlBtn">Unduh</button>
    <button id="shareBtn">Bagikan</button>
  </div>

<script>
(function(){
  const d = document;
  const canvas = d.getElementById('canvas'), ctx = canvas.getContext('2d');
  const ph = d.querySelector('.ph');
  const processBtn = d.getElementById('processBtn');
  const afterBar = d.getElementById('afterBar');
  const mask = d.getElementById('mask');
  const countNum = d.getElementById('countNum');
  const dlBtn = d.getElementById('dlBtn');
  const shareBtn = d.getElementById('shareBtn');
  const resetAllTop = d.getElementById('resetAllTop');

  let img = null, twibbon = null;
  let hasImage = false;
  let scale = 1, tx = 0, ty = 0;
  let gesturesEnabled = true;

  const TWIBBON_DEFAULT_URL = ''; // bisa isi twibbon default kalau ada

  function resizeCanvasToBox(){
    const box = d.getElementById('box');
    canvas.width = box.clientWidth;
    canvas.height = box.clientHeight;
    scheduleDraw();
  }

  function scheduleDraw(){
    requestAnimationFrame(draw);
  }

  function draw(){
    ctx.clearRect(0,0,canvas.width,canvas.height);
    if (hasImage && img){
      ctx.save();
      ctx.translate(canvas.width/2+tx, canvas.height/2+ty);
      ctx.scale(scale, scale);
      const ratio = Math.min(canvas.width/img.width, canvas.height/img.height);
      const w = img.width*ratio, h = img.height*ratio;
      ctx.drawImage(img, -w/2, -h/2, w, h);
      ctx.restore();
    }
    if (twibbon){
      ctx.drawImage(twibbon, 0, 0, canvas.width, canvas.height);
    }
  }

  function fitImage(){
    scale = 1; tx = 0; ty = 0;
  }

  function loadUserImage(file){
    if (!file) return;
    const url = URL.createObjectURL(file);
    const _img = new Image();
    _img.onload = () => {
      img = _img;
      hasImage = true;
      ph.style.display = 'none';
      fitImage(); scheduleDraw();
      processBtn.querySelector("span").textContent = "Buat";
      processBtn.classList.remove("processing","done");
      processBtn.classList.add("primary");
      processBtn.disabled = false;
      URL.revokeObjectURL(url);
      afterBar.classList.remove('show');
    };
    _img.src = url;
  }

  // ==== Proses ====
  const PROCESS_SECONDS = 15;
  let processing = false;
  processBtn.addEventListener('click', async ()=>{
    if (!hasImage || processing) return;

    processing = true;
    processBtn.disabled = true;
    processBtn.classList.remove("primary","done");
    processBtn.classList.add("processing");

    // Tambah spinner
    processBtn.innerHTML = '<div class="spinner"></div><span>Memproses...</span>';

    gesturesEnabled = false;
    mask.classList.add('active');

    let sec = PROCESS_SECONDS;
    countNum.textContent = sec;
    const tick = () => new Promise(r=>setTimeout(r,1000));
    while(sec > 0){ await tick(); sec--; countNum.textContent = sec; }

    countNum.textContent = '0';
    mask.classList.remove('active');
    afterBar.classList.add('show');

    processing = false;
    processBtn.innerHTML = '<span>Selesai</span>';
    processBtn.classList.remove("primary","processing");
    processBtn.classList.add("done");
    processBtn.disabled = true;
  });

  // ==== Unduh & Bagikan ====
  dlBtn.addEventListener('click', ()=>{
    gesturesEnabled = false;
    const link = d.createElement('a');
    link.download = 'twibbon.png';
    link.href = canvas.toDataURL('image/png');
    link.click();
  });
  shareBtn.addEventListener('click', ()=>{
    canvas.toBlob(async (blob)=>{
      if (!blob) return;
      const file = new File([blob], 'twibbon.png', {type:'image/png'});
      if (navigator.canShare && navigator.canShare({ files:[file] }) && navigator.share){
        try{ await navigator.share({ files:[file], title:'Twibbon', text:'Hasil twibbon saya' }); } catch(e){}
      } else {
        const url = URL.createObjectURL(blob);
        window.open(url, '_blank');
        setTimeout(()=>URL.revokeObjectURL(url), 15000);
      }
    });
  });

  // ==== Reset ====
  function resetAll(){
    hasImage = false; img = null;
    try {
      const defaultTw = new Image();
      defaultTw.onload = () => { twibbon = defaultTw; scheduleDraw(); };
      defaultTw.src = TWIBBON_DEFAULT_URL;
    } catch (e) { twibbon = null; scheduleDraw(); }
    ph.style.display = '';
    afterBar.classList.remove('show');
    processBtn.innerHTML = '<span>Buat</span>';
    processBtn.classList.remove("processing","done");
    processBtn.classList.add("primary");
    processBtn.disabled = true;
    scale = 1; tx = 0; ty = 0;
    gesturesEnabled = true;
  }
  resetAllTop.addEventListener('click', resetAll);

  resizeCanvasToBox(); scheduleDraw();
})();
</script>
</body>
</html>

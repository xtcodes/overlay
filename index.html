<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Twibbon App Final</title>
  <style>
    body {
      font-family: sans-serif;
      margin: 0;
      background: #f4f4f4;
      display: flex;
      flex-direction: column;
      align-items: center;
    }
    canvas {
      border: 2px dashed #aaa;
      background: #fff;
      margin-top: 20px;
      touch-action: none;
    }
    #uploadBtn {
      margin-top: -200px;
      position: absolute;
      z-index: 2;
      background: #3498db;
      color: white;
      border: none;
      padding: 12px 20px;
      border-radius: 6px;
      font-size: 16px;
      cursor: pointer;
    }
    #actionButtons {
      display: none;
      margin: 20px;
      display: flex;
      gap: 10px;
      width: 90%;
      max-width: 360px;
    }
    #actionButtons button {
      flex: 1;
      background: #2980b9;
      color: white;
      padding: 12px;
      font-size: 16px;
      border: none;
      border-radius: 6px;
      cursor: pointer;
    }
    #resetBtn {
      position: absolute;
      bottom: 16px;
      right: 16px;
      background: #e74c3c;
      color: white;
      border: none;
      padding: 10px;
      border-radius: 50%;
      font-size: 18px;
      cursor: pointer;
      display: none;
    }
  </style>
</head>
<body>

  <canvas id="canvas" width="320" height="320"></canvas>
  <button id="uploadBtn">Unggah Gambar</button>
  <input type="file" id="uploadInput" accept="image/*" style="display: none;" />

  <div id="actionButtons">
    <button id="downloadBtn">Unduh</button>
    <button id="shareBtn">Bagikan</button>
  </div>

  <button id="resetBtn">&#x21bb;</button>

  <script>
    const canvas = document.getElementById("canvas");
    const ctx = canvas.getContext("2d");
    const uploadBtn = document.getElementById("uploadBtn");
    const uploadInput = document.getElementById("uploadInput");
    const actionButtons = document.getElementById("actionButtons");
    const resetBtn = document.getElementById("resetBtn");
    const downloadBtn = document.getElementById("downloadBtn");

    let userImg = null;
    let twibbonImg = new Image();
    let dragging = false;
    let lastX, lastY;
    let dx = 0, dy = 0;
    let scale = 1;
    let startDistance = 0;
    let isInteracting = false;

    twibbonImg.src = "twibbon.png"; // pastikan file ini tersedia

    function getDistance(touches) {
      const dx = touches[0].clientX - touches[1].clientX;
      const dy = touches[0].clientY - touches[1].clientY;
      return Math.sqrt(dx * dx + dy * dy);
    }

    function render() {
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      if (!userImg) return;

      const imgAspect = userImg.width / userImg.height;
      const canvasAspect = canvas.width / canvas.height;
      let drawWidth, drawHeight;
      if (imgAspect > canvasAspect) {
        drawWidth = canvas.width * scale;
        drawHeight = drawWidth / imgAspect;
      } else {
        drawHeight = canvas.height * scale;
        drawWidth = drawHeight * imgAspect;
      }
      const offsetX = dx + (canvas.width - drawWidth) / 2;
      const offsetY = dy + (canvas.height - drawHeight) / 2;

      ctx.drawImage(userImg, offsetX, offsetY, drawWidth, drawHeight);

      if (twibbonImg && userImg) {
        ctx.globalAlpha = isInteracting ? 0.4 : 1;
        ctx.drawImage(twibbonImg, 0, 0, canvas.width, canvas.height);
        ctx.globalAlpha = 1;
      }
    }

    canvas.addEventListener("touchstart", (e) => {
      if (!userImg) return;
      if (e.touches.length === 1) {
        dragging = true;
        lastX = e.touches[0].clientX;
        lastY = e.touches[0].clientY;
        isInteracting = true;
      } else if (e.touches.length === 2) {
        startDistance = getDistance(e.touches);
        isInteracting = true;
      }
    });

    canvas.addEventListener("touchmove", (e) => {
      e.preventDefault();
      if (!userImg) return;
      if (e.touches.length === 1 && dragging) {
        const x = e.touches[0].clientX;
        const y = e.touches[0].clientY;
        dx += x - lastX;
        dy += y - lastY;
        lastX = x;
        lastY = y;
        render();
      } else if (e.touches.length === 2) {
        const newDistance = getDistance(e.touches);
        const zoom = newDistance / startDistance;
        scale *= zoom;
        startDistance = newDistance;
        render();
      }
    }, { passive: false });

    canvas.addEventListener("touchend", () => {
      dragging = false;
      isInteracting = false;
      render();
    });

    uploadBtn.onclick = () => uploadInput.click();
    uploadInput.onchange = (e) => {
      const file = e.target.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = () => {
        userImg = new Image();
        userImg.onload = () => {
          dx = 0;
          dy = 0;
          scale = 1;
          render();
          actionButtons.style.display = "flex";
          uploadBtn.style.display = "none";
          resetBtn.style.display = "block";
        };
        userImg.src = reader.result;
      };
      reader.readAsDataURL(file);
    };

    resetBtn.onclick = () => {
      userImg = null;
      uploadInput.value = "";
      uploadBtn.style.display = "inline-block";
      actionButtons.style.display = "none";
      resetBtn.style.display = "none";
      ctx.clearRect(0, 0, canvas.width, canvas.height);
    };

    downloadBtn.onclick = () => {
      const link = document.createElement("a");
      link.download = "twibboned.png";
      link.href = canvas.toDataURL();
      link.click();
    };
  </script>
</body>
</html>
